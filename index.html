




<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>An√°lisis y Probabilidad de Desapariciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* ===== DISE√ëO MEJORADO FEBRERO 2026===== */
/* ===== ELABOR√ì rys2000dev===== */

:root {
  --primary-color: #2c3e50;
  --secondary-color: #3498db;
  --accent-color: #e74c3c;
  --prediction-color: #9b59b6;
  --success-color: #27ae60;
  --light-bg: #f8f9fa;
  --card-bg: #ffffff;
  --border-color: #e0e0e0;
  --text-color: #333333;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --border-radius: 8px;
  --dual-color: #e74c3c;
  --benchmark-color: #27ae60;
  --scatter-color: #2196f3;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #f6f5ef;
  font-family: 'Segoe UI', Arial, sans-serif;
  color: var(--text-color);
  height: 100vh;
  overflow: hidden;
}

/* ===== HEADER ===== */
header#top-header {
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary-color);
  color: white;
  font-size: 16px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: relative;
  padding: 0 20px;
}

#top-header .title {
  margin: 0 auto;
  font-weight: 600;
  text-align: center;
}

#top-header button {
  position: absolute;
  right: 14px;
  padding: 6px 12px;
  border: 1px solid #000;
  background: #f6f5ef;
  cursor: pointer;
  border-radius: 6px;
  font-size: 12px;
  transition: all 0.2s;
}

#top-header button:hover {
  background: #e0e0e0;
  transform: translateY(-1px);
}

#layout {
  display: flex;
  height: calc(100vh - 50px);
  padding: 10px;
  gap: 10px;
  overflow: hidden;
}

#panel {
  width: 320px;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 10px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  max-height: 100%;
  transition: left 0.3s ease;
}

#panel::-webkit-scrollbar {
  width: 4px;
}

#panel::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 2px;
}

label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 2px;
  color: var(--text-color);
}

select, input {
  width: 100%;
  padding: 5px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: white;
  font-size: 12px;
  color: var(--text-color);
}

select:focus, input:focus {
  outline: none;
  border-color: var(--secondary-color);
}

/* Selectores m√∫ltiples con soporte t√°ctil */
select[multiple] {
  min-height: 60px;
  max-height: 90px;
  background: white;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

select[multiple] option {
  padding: 10px 6px; /* M√°s grande para m√≥vil */
  margin: 2px 0;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}

select[multiple] option:hover {
  background-color: var(--secondary-color);
  color: white;
}

select[multiple] option:checked {
  background-color: var(--primary-color);
  color: white;
  font-weight: bold;
  background-image: none;
}

/* Contadores de selecci√≥n */
.seleccion-contador {
  font-size: 10px;
  color: #666;
  margin-top: 3px;
  margin-bottom: 4px;
  padding: 6px 12px;
  background: var(--light-bg);
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.seleccion-contador span:first-child {
  font-weight: 600;
  color: var(--primary-color);
}

.seleccion-contador span:last-child {
  font-style: italic;
}

.btn-secundario {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 8px 8px; /* M√°s grande para m√≥vil */
  border-radius: 4px;
  cursor: pointer;
  margin-top: 5px;
  margin-bottom: 5px;
  font-size: 12px;
  width: 100%;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-height: 36px; /* Tama√±o m√≠nimo t√°ctil */
}

.btn-secundario:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.btn-secundario.active {
  background-color: #dc3545;
  box-shadow: 0 3px 6px rgba(220,53,69,0.3);
}

/* ===== BOT√ìN DE EXPANDIR/CONTRARER RESUMEN ===== */
.resumen-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--card-bg);
  padding: 8px 12px;
  border-radius: var(--border-radius);
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  cursor: pointer;
  transition: all 0.2s;
}

.resumen-header:hover {
  background: #f0f0f0;
}

.resumen-header h3 {
  font-size: 13px;
  font-weight: 600;
  color: var(--primary-color);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 6px;
}

.resumen-header .toggle-icon {
  font-size: 16px;
  color: var(--secondary-color);
  transition: transform 0.3s;
}

.resumen-header.collapsed .toggle-icon {
  transform: rotate(-90deg);
}

#resumenSeleccion {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 15px;
  font-family: Arial, sans-serif;
  transition: all 0.3s ease;
  overflow: hidden;
}

#resumenSeleccion.collapsed {
  display: none;
}

.tabla-container {
  overflow-x: auto;
  overflow-y: auto; /* Cambiar a auto para permitir scroll vertical */
  max-height: 300px; /* Altura m√°xima antes de mostrar scroll */
  -webkit-overflow-scrolling: touch;
  margin-top: 10px;
  border: 1px solid #ecf0f1; /* Borde sutil para delimitar el √°rea */
  border-radius: 4px;
  scrollbar-width: thin; /* Scroll m√°s delgado en Firefox */
}

/* Personalizar scrollbar para que se vea mejor */
.tabla-container::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.tabla-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.tabla-container::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 4px;
}

.tabla-container::-webkit-scrollbar-thumb:hover {
  background: var(--primary-color);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  min-width: 500px; 
}

thead tr {
  background: #3498db;
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

tfoot tr {
  background: #2c3e50;
  color: white;
  font-weight: bold;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

th {
  padding: 8px;
  text-align: left;
  white-space: nowrap;
}

th:first-child {
  border-radius: 4px 0 0 4px;
}

th:last-child {
  border-radius: 0 4px 4px 0;
}

tbody tr {
  border-bottom: 1px solid #ecf0f1;
}

tbody td {
  padding: 8px;
}

tbody td:nth-child(2) {
  background: #e8f8f5;
  color: #27ae60;
  font-weight: bold;
  text-align: center;
}

tbody td:nth-child(3) {
  background: #fdedec;
  color: #e74c3c;
  font-weight: bold;
  text-align: center;
}

tbody td:nth-child(4) {
  background: #fef5e7;
  color: #f39c12;
  font-weight: bold;
  text-align: center;
}

tbody td:nth-child(5) {
  background: #f4f6f7;
  font-weight: bold;
  text-align: center;
}

tfoot tr {
  background: #2c3e50;
  color: white;
  font-weight: bold;
}

tfoot td {
  padding: 8px;
  text-align: center;
}

.modo-avanzado-container {
  border-top: 1px solid var(--border-color);
  padding-top: 15px;
  margin-top: 10px;
}

.modo-avanzado-checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  border-radius: 6px;
  background: #f8f9fa;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 44px; /* Tama√±o t√°ctil */
}

.modo-avanzado-checkbox:hover {
  background: #e9ecef;
}

.modo-avanzado-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.modo-avanzado-checkbox span {
  font-weight: 600;
  font-size: 12px;
}

.modo-avanzado-controls {
  background: #fff3f3;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--dual-color);
  margin-bottom: 10px;
}

.benchmark-controls {
  background: #e8f5e9;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--benchmark-color);
  margin-bottom: 10px;
}

.scatter-controls {
  background: #e3f2fd;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--scatter-color);
  margin-bottom: 10px;
}

.dual-selector-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.dual-selector-item {
  flex: 1;
  min-width: 120px;
}

.dual-selector-item label {
  font-size: 11px;
  color: #666;
  margin-bottom: 2px;
}

.dual-ejemplo {
  font-size: 11px;
  color: #e74c3c;
  font-style: italic;
  background: #fff9f9;
  padding: 8px;
  border-radius: 4px;
  margin-top: 8px;
}

.benchmark-info {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.benchmark-card {
  flex: 1;
  min-width: 120px;
  background: white;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.benchmark-card h6 {
  font-size: 11px;
  color: #666;
  margin-bottom: 5px;
}

.benchmark-valor {
  font-size: 13px;
  font-weight: 600;
}

.benchmark-superior {
  color: #27ae60;
}

.benchmark-inferior {
  color: #e74c3c;
}

.prediction-section {
  background: rgba(155, 89, 182, 0.05);
  padding: 12px;
  border-radius: var(--border-radius);
  margin: 8px 0;
  border-left: 3px solid var(--prediction-color);
}

.prediction-section h4 {
  color: var(--prediction-color);
  margin-bottom: 10px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.radio-group {
  display: flex;
  gap: 15px;
  margin: 8px 0;
  flex-wrap: wrap;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  min-height: 40px;
}

.radio-option input[type="radio"] {
  width: 18px;
  height: 18px;
  accent-color: var(--prediction-color);
}

.range-container {
  margin: 8px 0;
}

.range-slider {
  width: 100%;
  height: 30px;
  accent-color: var(--prediction-color);
}

.range-value {
  text-align: center;
  font-size: 12px;
  color: var(--prediction-color);
  margin-top: 4px;
  font-weight: 600;
}

#chartTypes {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-top: 4px;
}

#chartTypes button {
  padding: 10px 4px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: white;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 40px;
}

#chartTypes button:hover {
  border-color: var(--secondary-color);
  transform: translateY(-1px);
  background: #f0f7ff;
}

#chartTypes button.active {
  background: var(--secondary-color);
  color: white;
  border-color: var(--secondary-color);
}

.btn-generar {
  margin-top: 15px;
  padding: 14px;
  border-radius: 6px;
  border: none;
  background: var(--success-color);
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  min-height: 48px;
}

.btn-generar:hover {
  background: #219653;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(39,174,96,0.3);
}

#btnPrediccion {
  background: var(--prediction-color);
  color: white;
  border: none;
  padding: 14px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 10px;
  width: 100%;
  min-height: 48px;
}

#btnPrediccion:hover {
  background: #8e44ad;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(155,89,182,0.3);
}

#btnPrediccion:disabled {
  background: #bdc3c7;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

#btnLimpiarTodo {
  background-color: #e67e22 !important;
  margin-top: 15px !important;
  padding: 14px !important;
  font-size: 13px !important;
  min-height: 48px !important;
  transition: all 0.3s ease;
}

#btnLimpiarTodo:hover {
  background-color: #d35400 !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(230,126,34,0.3);
}

.prediction-results {
  display: none;
  background: white;
  border-radius: var(--border-radius);
  padding: 15px;
  margin-top: 15px;
  border: 2px solid var(--prediction-color);
  box-shadow: var(--shadow);
}

.prediction-results h5 {
  color: var(--prediction-color);
  margin-bottom: 12px;
  font-size: 12px;
  border-bottom: 1px solid #eee;
  padding-bottom: 8px;
}

.result-item {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
  font-size: 12px;
}

.result-bar {
  height: 16px;
  background: #ecf0f1;
  border-radius: 6px;
  margin-top: 2px;
  overflow: hidden;
}

.result-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 1s ease-out;
}

.result-fill.con-vida { background: #2ecc71; }
.result-fill.desaparecida { background: #f39c12; }
.result-fill.sin-vida { background: #e74c3c; }

#creditos {
  text-align: center;
  margin-top: 20px;
  padding-top: 15px;
  font-size: 11px;
  color: #666;
  border-top: 1px solid var(--border-color);
}

#creditos a {
  color: var(--secondary-color);
  text-decoration: none;
  font-weight: 600;
}

#creditos a:hover {
  text-decoration: underline;
}

#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 0;
}

#resumen {
  background: var(--card-bg);
  padding: 12px;
  border-radius: var(--border-radius);
  font-weight: 600;
  text-align: center;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  font-size: 12px;
  color: var(--primary-color);
  min-height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  word-break: break-word;
}

.chart-container {
  flex: 1;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 15px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  min-height: 0;
  position: relative;
}

canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

#btnDescargar {
  align-self: flex-end;
  padding: 12px 20px;
  border-radius: 6px;
  border: none;
  background: var(--primary-color);
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 5px;
  min-height: 44px;
}

#btnDescargar:hover {
  background: #34495e;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* ===== MODALES ===== */
#modalNota, #modalPrediccion {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  backdrop-filter: blur(3px);
}

#modalContenido, .nota-contenido {
  background: #ffffff;
  max-width: 550px;
  max-height: 80vh;
  margin: 8vh auto;
  padding: 25px;
  border-radius: 12px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.6;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

#modalContenido h3, .nota-contenido h3 {
  margin-top: 0;
  text-align: center;
  color: var(--primary-color);
  border-bottom: 2px solid var(--secondary-color);
  padding-bottom: 12px;
}

#modalContenido button, .nota-contenido button {
  margin-top: 20px;
  width: 100%;
  padding: 14px;
  background: var(--primary-color);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  min-height: 48px;
}

#modalContenido button:hover, .nota-contenido button:hover {
  background: #1a2530;
  transform: translateY(-1px);
}

.model-status {
  font-size: 11px;
  text-align: center;
  padding: 8px;
  margin: 8px 0;
  border-radius: 4px;
  font-weight: 500;
}

.model-status.training {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.model-status.ready {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.model-status.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* ===== SECCIONES COLAPSABLES ===== */
.section-toggle {
  width: 100%;
  padding: 14px 16px;
  border-radius: 10px;
  border: 2px solid transparent;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.05), inset 0 1px 0 rgba(255,255,255,0.8);
  color: #2c3e50;
  font-size: 14px;
}

.section-toggle:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.9);
  border-color: #e0e0e0;
}

.section-toggle::after {
  content: "‚ñº";
  font-size: 12px;
  opacity: 0.7;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: rotate(0deg);
  font-weight: bold;
  margin-left: 8px;
}

.section-toggle.active {
  background: linear-gradient(145deg, var(--primary-color), #1a2530);
  color: white;
  border-color: var(--primary-color);
  box-shadow: 0 4px 16px rgba(44,62,80,0.15), 0 2px 8px rgba(44,62,80,0.1), inset 0 1px 0 rgba(255,255,255,0.2);
}

.section-toggle.active::after {
  transform: rotate(180deg);
  opacity: 1;
  color: rgba(255,255,255,0.9);
}

.section-content {
  margin: 8px 0 16px 0;
  padding: 0 4px;
  animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform-origin: top;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.section-content.collapsed {
  display: none;
}

.ayuda {
  font-size: 11px;
  color: #666;
  margin-top: 3px;
  font-style: italic;
  background: #f9f9f9;
  padding: 6px 8px;
  border-radius: 4px;
  border-left: 3px solid var(--secondary-color);
}

.masEspacio {
  margin-top: 20px;
}

#mobileToggle {
  display: none;
}

@media (max-width: 768px) {
  #panel {
    position: fixed;
    top: 0;
    left: -100%;
    width: 85%;
    height: 100%;
    z-index: 9999;
    transition: 0.3s;
  }

  #panel.open {
    left: 0;
  }

  #mobileToggle {
    display: flex;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary-color);
    color: #fff;
    font-size: 24px;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 10000;
  }

  #layout {
    flex-direction: column;
  }

  #panel {
    width: 100%;
    position: relative;
    left: 0;
  }

  .dual-selector-row {
    flex-direction: column;
  }

  .benchmark-info {
    flex-direction: column;
  }
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--light-bg);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-color);
}

.indicador-requerido {
  display: inline-block;
  background: var(--accent-color);
  color: white;
  font-size: 9px;
  padding: 6px 12px;
  border-radius: 10px;
  margin-left: 5px;
}

.contador-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2px;
}
</style>

</head>
<body>

<header id="top-header">
  <span class="title">
    üìä  Gr√°ficas y Probabilidad por Municipio - Jalisco
  </span>
  <button id="btnNota" onclick="abrirNota()">‚ÑπÔ∏è Nota metodol√≥gica</button>
</header>

<div id="layout">
  <!-- PANEL COMPACTO -->
  <div id="panel">
    <button class="section-toggle" onclick="toggleSection('graficas')">
      üìä Gr√°ficas
    </button>

<div id="section-graficas" class="section-content collapsed">
      <!-- SECCI√ìN DE AN√ÅLISIS -->

      <!-- Municipios -->
      <div>
        <div class="contador-wrapper">
          <label>Municipios <span class="indicador-requerido">requerido</span></label>
        </div>
        <select id="municipiosComparacion" multiple size="5"></select>
        <button id="seleccionarTodosMunicipios" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorMunicipiosComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 municipios</span>
        </div>
      </div>

      <!-- A√±os -->
      <div>
        <div class="contador-wrapper">
          <label>A√±os <span class="indicador-requerido">requerido</span></label>
        </div>
        <select id="aniosComparacion" multiple size="5"></select>
        <button id="seleccionarTodosAnios" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorAniosComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 a√±os</span>
        </div>
      </div>

      <!-- Sexo -->
      <div>
        <label>Sexo</label>
        <select id="sexoComparacion" multiple size="2"></select>
        <button id="seleccionarTodosSexos" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorSexoComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 sexos</span>
        </div>
      </div>

      <!-- Rango de Edad -->
      <div>
        <label>Rango de Edad</label>
        <select id="edadComparacion" multiple size="3"></select>
        <button id="seleccionarTodosEdades" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorEdadComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 rangos</span>
        </div>
      </div>

      <!-- Estado de Persona -->
      <div>
        <label>Estado de Persona</label>
        <select id="estadoComparacion" multiple size="2"></select>
        <button id="seleccionarTodosEstados" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorEstadoComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 estados</span>
        </div>
      </div>

      <!-- Condici√≥n de Localizaci√≥n -->
      <div>
        <label>Condici√≥n de Localizaci√≥n</label>
        <select id="condicionComparacion" multiple size="3"></select>
        <button id="seleccionarTodosCondiciones" class="btn-secundario">Seleccionar Todos</button>
        <div id="contadorCondicionComparacion" class="seleccion-contador">
          <span>Seleccionados:</span>
          <span>0 condiciones</span>
        </div>
      </div>

      <div class="masEspacio">
        <label>üìà Tipo de gr√°fica</label>
        <div id="chartTypes">
          <button data-type="bar">Barras</button>
          <button data-type="stackedBar">Barras Apiladas</button>
          <button data-type="line">L√≠nea</button>
          <button data-type="area">√Årea</button>
          <button data-type="stackedArea">√Årea Apiladas</button>
          <button data-type="pie">Pastel</button>
          <button data-type="doughnut">Donut</button>
        </div>
      </div>

<button id="btnGenerar" class="btn-generar">
  üöÄ Generar gr√°fica
</button>
    </div>


<button class="section-toggle" onclick="toggleSection('analisis')">
  üìä Comparaci√≥n Individual (Gr√°ficas)
</button>
<small class="section-subtitle">
  Comparaci√≥n de resultados por municipio, a√±o y casos
</small>

<div id="section-analisis" class="section-content collapsed">
       <label>Municipio y A√±o <span class="indicador-requerido">requerido</span></label>

      <div class="modo-avanzado-container">
        <!-- SELECTOR DUAL -->
        <div class="modo-avanzado-checkbox" style="background: #fff3f3;">
          <input type="checkbox" id="activarSelectorDual">
          <span style="color: #e74c3c;">üîÑ Modo comparaci√≥n dual</span>
        </div>
        <div id="dualControls" class="modo-avanzado-controls" style="display: none;">
          <div class="dual-selector-row">
            <div class="dual-selector-item">
              <label>Categor√≠a principal (eje X)</label>
              <select id="categoriaPrincipal" style="font-size: 11px;">
                <option value="condicion_localizacion">Condici√≥n</option>
                <option value="estatus_persona">Estado</option>
                <option value="sexo">Sexo</option>
                <option value="rango_edad">Rango de edad</option>
                <option value="a√±o">A√±o</option>
                <option value="municipio">Municipio</option>
              </select>
            </div>
            <div class="dual-selector-item">
              <label>Categor√≠a secundaria (colores)</label>
              <select id="categoriaSecundaria" style="font-size: 11px;">
                <option value="sexo">Sexo</option>
                <option value="condicion_localizacion">Condici√≥n</option>
                <option value="estatus_persona">Estado</option>
                <option value="rango_edad">Rango de edad</option>
                <option value="a√±o">A√±o</option>
                <option value="municipio">Municipio</option>
              </select>
            </div>
          </div>
          <div class="dual-ejemplo" id="dualEjemplo">
            Comparando: Condici√≥n vs Sexo
          </div>
        </div>

        <div class="modo-avanzado-checkbox" style="background: #e8f5e9; margin-top: 10px;">
          <input type="checkbox" id="activarBenchmark">
          <span style="color: #27ae60;">üìä Comparar con promedio estatal</span>
        </div>
        <div id="benchmarkControls" class="benchmark-controls" style="display: none;">
          <div style="margin-bottom: 10px;">
            <label style="font-size: 11px;">Municipio de referencia</label>
            <select id="municipioBenchmark" style="font-size: 11px;">
              <option value="">Selecciona un municipio</option>
            </select>
          </div>
          <div class="benchmark-info">
            <div class="benchmark-card">
              <h6>üìä Promedio estatal</h6>
              <div id="promedioEstatalInfo" style="font-size: 12px;">
                <span class="benchmark-valor">Cargando...</span>
              </div>
            </div>

<div class="benchmark-metrica-selector">
  <label>üìä M√©trica de comparaci√≥n:</label>
  <select id="metricaBenchmark" onchange="actualizarInfoBenchmark()">
    <option value="tasa_con_vida">% Localizados con vida</option>
    <option value="tasa_sin_vida">% Localizados sin vida</option>
    <option value="tasa_desaparecidos">% Desaparecidos</option>
    <option value="total_casos">Total de casos</option>
    <option value="casos_con_vida">Casos con vida</option>
  </select>
</div>
            <div class="benchmark-card">
              <h6 id="municipioBenchmarkLabel">üìç Municipio</h6>
              <div id="municipioBenchmarkInfo" style="font-size: 12px;">
                <span class="benchmark-valor">Selecciona un municipio</span>
              </div>
            </div>
          </div>
        </div>

<div class="modo-avanzado-checkbox" style="background: #e3f2fd; margin-top: 10px;">
  <input type="checkbox" id="activarDispersion">
  <span style="color: #2196f3;">‚ö° Modo an√°lisis: Dispersi√≥n municipios</span>
</div>
<div id="scatterControls" class="scatter-controls" style="display: none; padding: 10px; background: #f5f9ff; border-radius: 4px; margin-top: 5px;">

  <div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #bbdefb;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #0d47a1; font-size: 12px;">
      üìä ¬øQu√© quieres analizar en el eje Y?
    </label>
    <select id="metricaDispersion" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #90caf9; background: white; font-size: 12px;">
      <option value="tasa_con_vida" selected>üü¢ % Localizados con vida</option>
      <option value="tasa_sin_vida">üî¥ % Localizados sin vida</option>
      <option value="tasa_desaparecidos">üü° % Desaparecidos</option>
      <option value="total_casos">üîµ Total de casos</option>
      <option value="casos_con_vida">üü¢ Casos con vida</option>
    </select>
  </div>

  <div style="font-size: 12px; color: #0d47a1; background: white; padding: 10px; border-radius: 4px; border-left: 4px solid #2196f3;">
    <strong>üìà An√°lisis de efectividad por municipio</strong>
    <p style="margin-top: 8px; margin-bottom: 5px; line-height: 1.5;">
      <span style="display: inline-block; width: 70px;">üìç Eje X:</span> Total de casos<br>
      <span style="display: inline-block; width: 70px;">üìà Eje Y:</span> <span id="ejeyDescripcion">% Localizados con vida</span><br>
      <span style="display: inline-block; width: 70px;">üí° Cada punto:</span> Un municipio
    </p>
    <p style="margin-top: 8px; margin-bottom: 0; font-size: 11px; color: #666; border-top: 1px dashed #bbdefb; padding-top: 8px;">
      ‚ö° Los filtros de sexo, edad y estado aplican a todos los puntos
    </p>
  </div>

  <div style="margin-top: 10px; font-size: 11px; display: flex; gap: 10px; justify-content: center;">
    <span style="color: #27ae60;">üü¢ Con vida</span>
    <span style="color: #e74c3c;">üî¥ Sin vida</span>
    <span style="color: #f39c12;">üü° Desaparecidos</span>
  </div>
</div>
<button id="btnGenerarAvanzado" class="btn-generar">
  üöÄ Generar gr√°fica
</button>
      </div></div>


    <button class="section-toggle" onclick="toggleSection('prediccion')">
       Probabilidad
    </button>

    <div id="section-prediccion" class="section-content collapsed">
      <!-- SECCI√ìN DE PREDICCI√ìN -->
      <div class="prediction-section">
        <h4>üìä Probabilidad de Resultado</h4>

        <div id="modelStatus" class="model-status training">
          ‚è≥ Cargando datos de entrenamiento...
        </div>

        <label>Sexo</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="predSexo" value="MUJER" checked>
            Mujer
          </label>
          <label class="radio-option">
            <input type="radio" name="predSexo" value="HOMBRE">
            Hombre
          </label>
        </div>

        <label> Edad</label>
        <select id="predEdad">
          <option value="2">0-4 a√±os</option>
          <option value="7">5-9 a√±os</option>
          <option value="12">10-14 a√±os</option>
          <option value="17">15-19 a√±os</option>
          <option value="22">20-24 a√±os</option>
          <option value="27">25-29 a√±os</option>
          <option value="32">30-34 a√±os</option>
          <option value="37">35-39 a√±os</option>
          <option value="42">40-44 a√±os</option>
          <option value="47">45-49 a√±os</option>
          <option value="52">50-54 a√±os</option>
          <option value="57">55-59 a√±os</option>
          <option value="62">60-64 a√±os</option>
          <option value="67">65-69 a√±os</option>
          <option value="72">70-74 a√±os</option>
        </select>

        <label> Meses entre desaparici√≥n y reporte</label>
        <div class="range-container">
          <input type="range" id="predMeses" min="0" max="60" value="12" class="range-slider">
          <div class="range-value" id="mesesValue">12 meses</div>
        </div>

        <label>Municipio</label>
        <select id="predMunicipio"></select>

        <button id="btnPrediccion" disabled>
          ‚è≥ Modelo no listo
        </button>

        <!-- RESULTADOS DE PREDICCI√ìN -->
        <div id="predictionResults" class="prediction-results">
          <h5>üìä Probabilidades estimadas:</h5>

          <div class="result-item">
            <span>Con vida:</span>
            <span id="probConVida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barConVida" class="result-fill con-vida" style="width: 0%"></div>
          </div>

          <div class="result-item">
            <span>Desaparecida:</span>
            <span id="probDesaparecida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barDesaparecida" class="result-fill desaparecida" style="width: 0%"></div>
          </div>

          <div class="result-item">
            <span>Sin vida:</span>
            <span id="probSinVida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barSinVida" class="result-fill sin-vida" style="width: 0%"></div>
          </div>

          <div style="margin-top: 12px; font-size: 10px; color: #666; text-align: center; background: #f9f9f9; padding: 8px; border-radius: 4px;" id="modelInfo">
            Modelo basado en datos hist√≥ricos
          </div>
        </div>
      </div>

      <button id="btnNotaPrediccion" onclick="abrirPrediccion()" class="btn-secundario">‚ÑπÔ∏è Nota sobre el modelo de probabilidad</button>
    </div>

    <div id="creditos">
      Elaborado por <a href="https://x.com/rys2000dev" target="_blank">rys2000dev</a>
      <br>
      Acad√©mico <a href="https://x.com/joraplas?lang=es" target="_blank">joraplas</a>
    </div>
  </div>

  <!-- GR√ÅFICA -->
  <div id="main">
<!-- RESUMEN DE SELECCI√ìN Y TABLA DE RESULTADOS -->
<div id="resumen">üìä Selecciona los filtros y haz clic en "Generar gr√°fica"</div>

<!-- NUEVO: RESUMEN DETALLADO CON BOT√ìN EXPANDIR/CONTRARER -->
<div class="resumen-header" onclick="toggleResumen()">
  <h3>
    <span>üìä RESUMEN DE AN√ÅLISIS</span>
    <span id="fechaActualizacion" style="font-size: 11px; color: #7f8c8d; margin-left: 8px;">
      <span id="fechaHora">-</span>
    </span>
  </h3>
  <span class="toggle-icon">‚ñº</span>
</div>

<div id="resumenSeleccion" class="collapsed">
  <!-- Municipios seleccionados -->
  <div style="margin-bottom: 8px;">
    <span style="font-weight: bold; color: #2c3e50;">üìç Municipios:</span>
    <span id="municipiosResumen" style="color: #27ae60; font-size: 13px;">-</span>
  </div>
  
  <!-- A√±os seleccionados -->
  <div style="margin-bottom: 8px;">
    <span style="font-weight: bold; color: #2c3e50;">üìÖ A√±os:</span>
    <span id="aniosResumen" style="color: #2980b9; font-size: 13px;">-</span>
  </div>
  
  <!-- Filtros adicionales -->
  <div style="margin-bottom: 8px; font-size: 12px; color: #7f8c8d;">
    <span id="filtrosAdicionales">-</span>
  </div>
  
  <div class="tabla-container" style="max-height: 300px;">
    <table>
      <thead>
        <tr>
          <th>Municipio</th>
          <th>üü¢ CON VIDA</th>
          <th>üî¥ SIN VIDA</th>
          <th>üü° DESAPARECIDO</th>
          <th>üìä TOTAL</th>
        </tr>
      </thead>
      <tbody id="tablaResumenBody">
        <tr><td colspan="5" style="padding: 20px; text-align: center; color: #7f8c8d;">Genera una gr√°fica para ver los resultados</td></tr>
      </tbody>
      <tfoot id="tablaResumenFoot">
        <!-- Totales generales se llenan din√°micamente -->
      </tfoot>
    </table>
  </div>
</div>
    

    <div class="chart-container">
      <canvas id="grafica"></canvas>
    </div>

    <button id="btnDescargar" onclick="descargarGrafica()">
      ‚¨áÔ∏è Descargar gr√°fica
    </button>
  </div>
</div>

<div id="modalNota">
  <div id="modalContenido">
    <h3>üìò Nota metodol√≥gica</h3>
    <p>La informaci√≥n presentada en esta p√°gina se basa en datos p√∫blicos obtenidos
      del Registro Estatal de Personas Desaparecidas del Estado de Jalisco, disponible
      en su versi√≥n p√∫blica en: <br>
      <a href="https://version-publica-repd.jalisco.gob.mx/" target="_blank">https://version-publica-repd.jalisco.gob.mx/</a>
    </p>

    <p><strong>üìä Fuente de datos</strong></p>
    <p>El conjunto de datos original incluye 37,173 registros correspondientes a
      personas reportadas como desaparecidas en el estado de Jalisco,
      con fechas que abarcan desde el a√±o 1942 hasta Enero de 2026.
    </p>

    <p><strong>üßπ Proceso de depuraci√≥n</strong></p>
    <p>Para el an√°lisis y visualizaci√≥n de la informaci√≥n se realiz√≥ un proceso de depuraci√≥n
      y normalizaci√≥n que incluy√≥, entre otros aspectos:<br><br>
      ‚Ä¢ Homologaci√≥n de nombres de municipios y variables<br>
      ‚Ä¢ Agrupaci√≥n temporal por a√±o<br>
      ‚Ä¢ Clasificaci√≥n por g√©nero, rango de edad y estatus del caso<br>
      ‚Ä¢ Se excluyeron 954 registros por falta de informaci√≥n m√≠nima necesaria
    </p>

    <p><strong>üìà Alcance del an√°lisis</strong></p>
    <p>Las gr√°ficas presentadas tienen un car√°cter descriptivo y exploratorio,
      con el objetivo de identificar patrones temporales y geogr√°ficos, as√≠ como
      facilitar la comprensi√≥n de la magnitud del fen√≥meno.
    </p>

    <p><strong>‚ö†Ô∏è Consideraciones importantes</strong><br>
      ‚Ä¢ Los datos reflejan reportes administrativos, pueden existir rezagos o actualizaciones<br>
      ‚Ä¢ La ausencia de un registro no implica la inexistencia del caso<br>
      ‚Ä¢ Las cifras pueden diferir de otros informes oficiales por fechas de corte o criterios
    </p>

    <button onclick="cerrarNota()">Cerrar</button>
  </div>
</div>

<div id="modalPrediccion">
  <div class="nota-contenido">
    <h3>üìä Nota Metodol√≥gica - Modelo de Probabilidad</h3>

    <p><strong>√öltima actualizaci√≥n:</strong> 11 de febrero de 2026</p>

    <h4>üß† Modelo Implementado</h4>
    <p>
      Sistema de <strong>estimaci√≥n probabil√≠stica basada en estad√≠sticas hist√≥ricas</strong>
      (Naive Bayes simplificado), dise√±ado para identificar patrones observados en
      registros anteriores y generar estimaciones orientativas.
    </p>

    <h4>‚öôÔ∏è Variables Analizadas</h4>
    <ul>
      <li><strong>Municipio:</strong> patrones geogr√°ficos hist√≥ricos</li>
      <li><strong>Sexo:</strong> tendencias observadas por g√©nero</li>
      <li><strong>Edad:</strong> 15 rangos etarios (0-4 a 70-74)</li>
      <li><strong>Tiempo:</strong> meses transcurridos desde la desaparici√≥n</li>
    </ul>

    <h4>üìà Fuente de Datos</h4>
    <p>
      Modelo construido a partir de <strong>35,998 registros hist√≥ricos</strong> del
      Registro Estatal de Personas Desaparecidas de Jalisco (1942-2025).
    </p>

    <h4>‚ö†Ô∏è Limitaciones</h4>
    <ul>
      <li>‚ùå No utiliza machine learning avanzado</li>
      <li>‚ùå No incorpora variables socioecon√≥micas</li>
      <li>‚ùå No analiza circunstancias espec√≠ficas de cada caso</li>
    </ul>

    <div style="background:#f8f9fa; padding:15px; border-radius:6px; margin-top:20px; border-left:4px solid #3498db;">
      <p><strong>üìù Responsabilidad √âtica</strong></p>
      <p style="margin-bottom:0;">
        Esta herramienta tiene fines informativos y sociales. No sustituye investigaciones oficiales.
        <strong>Las estimaciones son orientaci√≥n estad√≠stica, no conclusiones definitivas.</strong>
      </p>
    </div>

    <button onclick="cerrarPrediccion()">Cerrar</button>
  </div>
</div>

<script>

let datos = [];
let datosEntrenamiento = [];
let chartAnalisis;
let chartType = "bar";
let predictor;

let modoAvanzado = {
  dual: false,
  benchmark: false,
  dispersion: false
};


const watermarkPlugin = {
  id: 'watermark',
  afterDraw(chart, args, options) {
    const { ctx, chartArea } = chart;
    if (!chartArea) return;
    const { text = 'rys2000dev', fontSize = 26, opacity = 0.07, color = '#000', angle = 0 } = options;
    ctx.save();
    ctx.translate(chartArea.left + chartArea.width / 2, chartArea.top + chartArea.height / 2);
    ctx.rotate(angle * Math.PI / 180);
    ctx.globalAlpha = opacity;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `bold ${fontSize}px Helvetica, Arial, sans-serif`;
    ctx.fillText(text, 0, 0);
    ctx.restore();
  }
};

const whiteBackgroundPlugin = {
  id: 'whiteBackground',
  beforeDraw(chart) {
    const { ctx, width, height } = chart;
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.restore();
  }
};

Chart.register(ChartDataLabels, watermarkPlugin, whiteBackgroundPlugin);

const BASE_COLORS = [
  '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
  '#1abc9c', '#34495e', '#e67e22', '#16a085', '#8e44ad',
  '#27ae60', '#d35400', '#c0392b', '#2980b9', '#8e44ad'
];

function apply3DEffects(datasets, type, fillArea) {
  return datasets.map((ds, index) => {
    const newDataset = { ...ds };
    const colorIndex = index % BASE_COLORS.length;
    const baseColor = BASE_COLORS[colorIndex];
    const r = parseInt(baseColor.slice(1, 3), 16);
    const g = parseInt(baseColor.slice(3, 5), 16);
    const b = parseInt(baseColor.slice(5, 7), 16);

    switch(type) {
      case 'bar':
      case 'stackedBar':
        newDataset.barPercentage = 0.7;
        newDataset.categoryPercentage = 0.8;
        newDataset.borderRadius = { topLeft: 8, topRight: 8, bottomLeft: 3, bottomRight: 3 };
        newDataset.borderSkipped = false;
        newDataset.borderWidth = 2;
        newDataset.borderColor = `rgba(${Math.max(0, r-50)}, ${Math.max(0, g-50)}, ${Math.max(0, b-50)}, 1)`;
        newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
        break;
      case 'pie':
      case 'doughnut':
        newDataset.borderWidth = 3;
        newDataset.borderColor = '#ffffff';
        newDataset.borderAlign = 'inner';
        newDataset.hoverOffset = 15;
        newDataset.borderRadius = 5;
        newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
        break;
      case 'line':
      case 'area':
        newDataset.borderWidth = 3;
        newDataset.tension = 0.35;
        newDataset.fill = fillArea;
        newDataset.pointRadius = 10;
        newDataset.pointHoverRadius = 13;
        newDataset.pointBorderWidth = 2;
        newDataset.pointBackgroundColor = baseColor;
        newDataset.pointBorderColor = '#ffffff';
        newDataset.borderColor = baseColor;
        if (fillArea) newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.25)`;
        break;
    }
    return newDataset;
  });
}

function llenarSelectorMultiple(id, valores) {
  const select = document.getElementById(id);
  if (!select) return;
  select.innerHTML = '';
  valores.forEach(valor => {
    const option = document.createElement('option');
    option.value = valor;
    option.textContent = valor;
    select.appendChild(option);
  });
}

function actualizarContador(id) {
  const select = document.getElementById(id);
  if (!select) return;
  const opciones = Array.from(select.options);
  const seleccionadas = opciones.filter(o => o.selected);
  const contador = document.getElementById(`contador${id.charAt(0).toUpperCase() + id.slice(1)}`);
  if (!contador) return;

  const total = opciones.length;
  const seleccionadasCount = seleccionadas.length;
  let texto = '';

  if (seleccionadasCount === 0) {
    texto = '0 seleccionados';
  } else if (seleccionadasCount === total) {
    texto = `Todos (${total})`;
  } else {
    texto = `${seleccionadasCount} de ${total}`;
  }

  contador.innerHTML = `<span>Seleccionados:</span> <span>${texto}</span>`;
}

function configurarBotonSeleccionarTodos(botonId, selectId) {
  const boton = document.getElementById(botonId);
  const select = document.getElementById(selectId);
  if (!boton || !select) return;

  boton.addEventListener('click', function(e) {
    e.preventDefault();
    const opciones = Array.from(select.options);
    const seleccionadas = opciones.filter(o => o.selected);

    if (seleccionadas.length === opciones.length) {
      opciones.forEach(o => o.selected = false);
      this.textContent = 'Seleccionar Todos';
      this.classList.remove('active');
    } else {
      opciones.forEach(o => o.selected = true);
      this.textContent = 'Deseleccionar Todos';
      this.classList.add('active');
    }
    actualizarContador(selectId);
    select.dispatchEvent(new Event('change'));
  });
}

function obtenerValoresSeleccionados(id) {
  const select = document.getElementById(id);
  if (!select) return [];
  return Array.from(select.selectedOptions).map(opt => opt.value);
}


function habilitarSeleccionFluida(selectId, contadorId, textoUnidad) {
  const select = document.getElementById(selectId);
  const contador = document.getElementById(contadorId);
  if (!select || !contador) return;

  let arrastrando = false;
  let touchActivo = false;

  // Soporte para mouse (arrastre)
  select.addEventListener("mousedown", e => {
    if (e.target.tagName === "OPTION") {
      arrastrando = true;
      e.preventDefault();
    }
  });

  document.addEventListener("mouseup", () => {
    if (arrastrando) {
      arrastrando = false;
      actualizarContador(selectId);
    }
  });

  select.addEventListener("mousemove", e => {
    if (!arrastrando) return;
    if (e.target.tagName === "OPTION") {
      e.target.selected = true;
      actualizarContador(selectId);
    }
  });

  // Soporte t√°ctil mejorado
  select.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    if (element && element.tagName === "OPTION") {
      e.preventDefault();
      touchActivo = true;
      
      // En m√≥vil, alternar selecci√≥n con un toque
      if (!element.selected) {
        element.selected = true;
      } else {
        element.selected = false;
      }
      actualizarContador(selectId);
    }
  });

  select.addEventListener("touchmove", e => {
    e.preventDefault();
    if (!touchActivo) return;

    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (element && element.tagName === "OPTION") {
      // En m√≥vil, seleccionar al arrastrar
      if (!element.selected) {
        element.selected = true;
        actualizarContador(selectId);
      }
    }
  });

  select.addEventListener("touchend", () => {
    touchActivo = false;
  });

  // Click normal para escritorio
  select.addEventListener("click", e => {
    if (e.target.tagName === "OPTION") {
      e.preventDefault();
      e.target.selected = !e.target.selected;
      actualizarContador(selectId);
    }
  });
}


function ordenarMunicipiosPorCasos() {
  if (!datos || datos.length === 0) return [];

  // Calcular total de casos por municipio
  const municipiosTotales = {};
  datos.forEach(d => {
    const total = Number(d.total) || 0;
    municipiosTotales[d.municipio] = (municipiosTotales[d.municipio] || 0) + total;
  });

  // Convertir a array y ordenar por total descendente
  const municipiosOrdenados = Object.entries(municipiosTotales)
    .sort((a, b) => b[1] - a[1])
    .map(([municipio]) => municipio);

  // Separar top 10 y el resto
  const top10 = municipiosOrdenados.slice(0, 10);
  const resto = municipiosOrdenados.slice(10).sort();

  // Combinar: top 10 (orden descendente) + resto (alfab√©tico)
  return [...top10, ...resto];
}

function poblarSelectoresGraficas() {
  if (!datos || datos.length === 0) return;

  try {
    // Municipios ordenados: top 10 por casos + resto alfab√©tico
    const municipiosOrdenados = ordenarMunicipiosPorCasos();
    llenarSelectorMultiple('municipiosComparacion', municipiosOrdenados);
    configurarBotonSeleccionarTodos('seleccionarTodosMunicipios', 'municipiosComparacion');
    habilitarSeleccionFluida('municipiosComparacion', 'contadorMunicipiosComparacion', 'municipios');

    // A√±os
    let anios = [];
    if (datos[0].hasOwnProperty('a√±o')) {
      anios = [...new Set(datos.map(d => d.a√±o))].filter(v => v != null).map(String).sort((a, b) => b - a);
    } else {
      anios = ['2024', '2025', '2026'];
    }
    llenarSelectorMultiple('aniosComparacion', anios);
    configurarBotonSeleccionarTodos('seleccionarTodosAnios', 'aniosComparacion');
    habilitarSeleccionFluida('aniosComparacion', 'contadorAniosComparacion', 'a√±os');

    // Sexos
    const sexos = [...new Set(datos.map(d => d.sexo))].filter(v => v != null).sort();
    llenarSelectorMultiple('sexoComparacion', sexos);
    configurarBotonSeleccionarTodos('seleccionarTodosSexos', 'sexoComparacion');
    habilitarSeleccionFluida('sexoComparacion', 'contadorSexoComparacion', 'sexos');

    // Rangos de edad
    const rangosEdad = [...new Set(datos.map(d => d.rango_edad))].filter(v => v != null).sort();
    llenarSelectorMultiple('edadComparacion', rangosEdad);
    configurarBotonSeleccionarTodos('seleccionarTodosEdades', 'edadComparacion');
    habilitarSeleccionFluida('edadComparacion', 'contadorEdadComparacion', 'rangos');

    // Estados
    let estados = [];
    if (datos[0].hasOwnProperty('estatus_persona')) {
      estados = [...new Set(datos.map(d => d.estatus_persona))].filter(v => v != null).sort();
    }
    llenarSelectorMultiple('estadoComparacion', estados);
    configurarBotonSeleccionarTodos('seleccionarTodosEstados', 'estadoComparacion');
    habilitarSeleccionFluida('estadoComparacion', 'contadorEstadoComparacion', 'estados');

    // Condiciones
    let condiciones = [];
    if (datos[0].hasOwnProperty('condicion_localizacion')) {
      condiciones = [...new Set(datos.map(d => d.condicion_localizacion))].filter(v => v != null);
      const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
      condiciones.sort((a, b) => {
        const ia = orden.indexOf(a);
        const ib = orden.indexOf(b);
        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
    }
    llenarSelectorMultiple('condicionComparacion', condiciones);
    configurarBotonSeleccionarTodos('seleccionarTodosCondiciones', 'condicionComparacion');
    habilitarSeleccionFluida('condicionComparacion', 'contadorCondicionComparacion', 'condiciones');

    // Selector de municipios para predicci√≥n
    const selectPredMunicipio = document.getElementById('predMunicipio');
    if (selectPredMunicipio) {
      selectPredMunicipio.innerHTML = '<option value="">Selecciona un municipio</option>';
      municipiosOrdenados.forEach(mun => {
        selectPredMunicipio.innerHTML += `<option value="${mun}">${mun}</option>`;
      });
    }

    // Selector de municipios para benchmark
    const selectBenchmark = document.getElementById('municipioBenchmark');
    if (selectBenchmark) {
      selectBenchmark.innerHTML = '<option value="">Selecciona un municipio</option>';
      municipiosOrdenados.forEach(mun => {
        selectBenchmark.innerHTML += `<option value="${mun}">${mun}</option>`;
      });
    }

    if (!document.getElementById('btnLimpiarTodo')) {
      const btnLimpiar = document.createElement('button');
      btnLimpiar.id = 'btnLimpiarTodo';
      btnLimpiar.className = 'btn-secundario';
      btnLimpiar.innerHTML = 'üßπ Limpiar todos los filtros';
      btnLimpiar.addEventListener('click', limpiarTodosLosFiltros);
      document.getElementById('panel').insertBefore(btnLimpiar, document.getElementById('creditos'));
    }

    ['municipiosComparacion', 'aniosComparacion', 'sexoComparacion', 'edadComparacion', 'estadoComparacion', 'condicionComparacion']
      .forEach(id => actualizarContador(id));

    inicializarModoAvanzado();

  } catch (error) {
    console.error("Error poblando selectores:", error);
  }
}

let modoAvanzadoInicializado = false;

function inicializarModoAvanzado() {
  if (modoAvanzadoInicializado) return;

  if (!datos || datos.length === 0) {
    setTimeout(inicializarModoAvanzado, 500);
    return;
  }

  modoAvanzadoInicializado = true;
  console.log("üîÑ Inicializando modo avanzado...");

  const dualCheck = document.getElementById('activarSelectorDual');
  const dualControls = document.getElementById('dualControls');
  const catPrincipal = document.getElementById('categoriaPrincipal');
  const catSecundaria = document.getElementById('categoriaSecundaria');
  const dualEjemplo = document.getElementById('dualEjemplo');

  if (dualCheck && dualControls) {
    dualCheck.addEventListener('change', function() {
      modoAvanzado.dual = this.checked;
      if (this.checked) {
        modoAvanzado.benchmark = false;
        modoAvanzado.dispersion = false;
        document.getElementById('activarBenchmark') && (document.getElementById('activarBenchmark').checked = false);
        document.getElementById('activarDispersion') && (document.getElementById('activarDispersion').checked = false);
        document.getElementById('benchmarkControls') && (document.getElementById('benchmarkControls').style.display = 'none');
        document.getElementById('scatterControls') && (document.getElementById('scatterControls').style.display = 'none');
      }
      dualControls.style.display = this.checked ? 'block' : 'none';
    });
  }

  if (catPrincipal && catSecundaria && dualEjemplo) {
    function actualizarEjemplo() {
      dualEjemplo.textContent = `Comparando: ${catPrincipal.options[catPrincipal.selectedIndex]?.text || ''} vs ${catSecundaria.options[catSecundaria.selectedIndex]?.text || ''}`;
    }
    catPrincipal.addEventListener('change', actualizarEjemplo);
    catSecundaria.addEventListener('change', actualizarEjemplo);
    actualizarEjemplo();
  }

  const benchmarkCheck = document.getElementById('activarBenchmark');
  const benchmarkControls = document.getElementById('benchmarkControls');
  const municipioBenchmark = document.getElementById('municipioBenchmark');

  if (benchmarkCheck && benchmarkControls) {
    benchmarkCheck.addEventListener('change', function() {
      modoAvanzado.benchmark = this.checked;
      if (this.checked) {
        modoAvanzado.dual = false;
        modoAvanzado.dispersion = false;
        document.getElementById('activarSelectorDual') && (document.getElementById('activarSelectorDual').checked = false);
        document.getElementById('activarDispersion') && (document.getElementById('activarDispersion').checked = false);
        document.getElementById('dualControls') && (document.getElementById('dualControls').style.display = 'none');
        document.getElementById('scatterControls') && (document.getElementById('scatterControls').style.display = 'none');
      }
      benchmarkControls.style.display = this.checked ? 'block' : 'none';
    });
  }

  if (municipioBenchmark) {
    municipioBenchmark.addEventListener('change', actualizarInfoBenchmark);
  }

  const scatterCheck = document.getElementById('activarDispersion');
  const scatterControls = document.getElementById('scatterControls');

  if (scatterCheck && scatterControls) {
    scatterCheck.addEventListener('change', function() {
      modoAvanzado.dispersion = this.checked;
      if (this.checked) {
        modoAvanzado.dual = false;
        modoAvanzado.benchmark = false;
        document.getElementById('activarSelectorDual') && (document.getElementById('activarSelectorDual').checked = false);
        document.getElementById('activarBenchmark') && (document.getElementById('activarBenchmark').checked = false);
        document.getElementById('dualControls') && (document.getElementById('dualControls').style.display = 'none');
        document.getElementById('benchmarkControls') && (document.getElementById('benchmarkControls').style.display = 'none');
      }
      scatterControls.style.display = this.checked ? 'block' : 'none';
    });
  }
}

function limpiarTodosLosFiltros() {
  const selectores = [
    'municipiosComparacion', 'aniosComparacion', 'sexoComparacion',
    'edadComparacion', 'estadoComparacion', 'condicionComparacion'
  ];

  selectores.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      Array.from(select.options).forEach(opt => opt.selected = false);
      const botonId = `seleccionarTodos${id.charAt(0).toUpperCase() + id.slice(1)}`;
      const boton = document.getElementById(botonId);
      if (boton) {
        boton.textContent = 'Seleccionar Todos';
        boton.classList.remove('active');
      }
      actualizarContador(id);
    }
  });

  document.getElementById('activarSelectorDual') && (document.getElementById('activarSelectorDual').checked = false);
  document.getElementById('activarBenchmark') && (document.getElementById('activarBenchmark').checked = false);
  document.getElementById('activarDispersion') && (document.getElementById('activarDispersion').checked = false);

  modoAvanzado.dual = false;
  modoAvanzado.benchmark = false;
  modoAvanzado.dispersion = false;

  document.getElementById('dualControls') && (document.getElementById('dualControls').style.display = 'none');
  document.getElementById('benchmarkControls') && (document.getElementById('benchmarkControls').style.display = 'none');
  document.getElementById('scatterControls') && (document.getElementById('scatterControls').style.display = 'none');
}

const METRICAS_DISPONIBLES = {
  'tasa_con_vida': {
    nombre: '% Localizados con vida',
    calcular: (total, conVida) => total > 0 ? (conVida / total) * 100 : 0,
    color: '#27ae60',
    invertir: false,
    formatear: valor => `${valor.toFixed(1)}%`
  },
  'tasa_sin_vida': {
    nombre: '% Localizados sin vida',
    calcular: (total, sinVida) => total > 0 ? (sinVida / total) * 100 : 0,
    color: '#e74c3c',
    invertir: true,
    formatear: valor => `${valor.toFixed(1)}%`
  },
  'tasa_desaparecidos': {
    nombre: '% Desaparecidos',
    calcular: (total, desaparecidos) => total > 0 ? (desaparecidos / total) * 100 : 0,
    color: '#f39c12',
    invertir: true,
    formatear: valor => `${valor.toFixed(1)}%`
  },
  'total_casos': {
    nombre: 'Total de casos',
    calcular: (total) => total,
    color: '#3498db',
    invertir: true,
    formatear: valor => valor.toLocaleString()
  },
  'casos_con_vida': {
    nombre: 'Localizados con vida',
    calcular: (total, conVida) => conVida,
    color: '#2ecc71',
    invertir: false,
    formatear: valor => valor.toLocaleString()
  }
};

let metricaBenchmarkActiva = 'tasa_con_vida';

function actualizarDescripcionDispersion() {
  const select = document.getElementById('metricaDispersion');
  const descripcion = document.getElementById('ejeyDescripcion');
  if (!select || !descripcion) return;

  const valor = select.value;
  const opcionSeleccionada = select.options[select.selectedIndex].text;

  let textoLimpio = opcionSeleccionada.replace(/üü¢|üî¥|üü°|üîµ/g, '').trim();
  descripcion.textContent = textoLimpio;

  descripcion.style.color =
    valor.includes('con_vida') ? '#27ae60' :
    valor.includes('sin_vida') ? '#e74c3c' :
    valor.includes('desaparecidos') ? '#f39c12' : '#2196f3';
}

document.addEventListener('DOMContentLoaded', function() {
  const selectDispersion = document.getElementById('metricaDispersion');
  if (selectDispersion) {
    selectDispersion.addEventListener('change', function() {
      actualizarDescripcionDispersion();
      if (document.getElementById('activarDispersion')?.checked) {
        generarGrafica();
      }
    });
  }
  actualizarDescripcionDispersion();
});

function cargarMunicipiosBenchmark() {
  const select = document.getElementById('municipioBenchmark');
  if (!select || !datos.length) return;

  const municipios = ordenarMunicipiosPorCasos();
  
  select.innerHTML = '<option value="">Selecciona un municipio</option>';
  municipios.forEach(mun => {
    select.innerHTML += `<option value="${mun}">${mun}</option>`;
  });
}

function actualizarInfoBenchmark() {
  const municipio = document.getElementById('municipioBenchmark')?.value;
  if (!municipio || !datos.length) return;

  const sexos = obtenerValoresSeleccionados('sexoComparacion');
  const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
  const estados = obtenerValoresSeleccionados('estadoComparacion');
  const condiciones = obtenerValoresSeleccionados('condicionComparacion');
  const aniosRecientes = obtenerValoresSeleccionados('aniosComparacion');

  if (aniosRecientes.length === 0) return;

  const metricaSelector = document.getElementById('metricaBenchmark');
  const metricaKey = metricaSelector?.value || 'tasa_con_vida';
  const metrica = METRICAS_DISPONIBLES[metricaKey];

  const filtroBase = d =>
    aniosRecientes.includes(String(d.a√±o)) &&
    (sexos.length === 0 || sexos.includes(d.sexo)) &&
    (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
    (estados.length === 0 || estados.includes(d.estatus_persona));

  const datosEstado = datos.filter(filtroBase);
  const totalEstado = datosEstado.reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  const conVidaEstado = datosEstado
    .filter(d => d.condicion_localizacion === "CON VIDA" || d.condicion_localizacion === "Con vida")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  const sinVidaEstado = datosEstado
    .filter(d => d.condicion_localizacion === "SIN VIDA" || d.condicion_localizacion === "Sin vida")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  const desaparecidosEstado = datosEstado
    .filter(d => d.condicion_localizacion === "Desaparecida" || d.condicion_localizacion === "DESAPARECIDA")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  let valorEstado;
  if (metricaKey === 'tasa_con_vida') {
    valorEstado = totalEstado > 0 ? (conVidaEstado / totalEstado) * 100 : 0;
  } else if (metricaKey === 'tasa_sin_vida') {
    valorEstado = totalEstado > 0 ? (sinVidaEstado / totalEstado) * 100 : 0;
  } else if (metricaKey === 'tasa_desaparecidos') {
    valorEstado = totalEstado > 0 ? (desaparecidosEstado / totalEstado) * 100 : 0;
  } else if (metricaKey === 'total_casos') {
    valorEstado = totalEstado;
  } else if (metricaKey === 'casos_con_vida') {
    valorEstado = conVidaEstado;
  }

  const datosMunicipio = datos.filter(d =>
    d.municipio === municipio && filtroBase(d)
  );

  const totalMunicipio = datosMunicipio.reduce((sum, d) => sum + (Number(d.total) || 0), 0);
  const conVidaMunicipio = datosMunicipio
    .filter(d => d.condicion_localizacion === "CON VIDA" || d.condicion_localizacion === "Con vida")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  const sinVidaMunicipio = datosMunicipio
    .filter(d => d.condicion_localizacion === "SIN VIDA" || d.condicion_localizacion === "Sin vida")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  const desaparecidosMunicipio = datosMunicipio
    .filter(d => d.condicion_localizacion === "Desaparecida" || d.condicion_localizacion === "DESAPARECIDA")
    .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

  let valorMunicipio;
  if (metricaKey === 'tasa_con_vida') {
    valorMunicipio = totalMunicipio > 0 ? (conVidaMunicipio / totalMunicipio) * 100 : 0;
  } else if (metricaKey === 'tasa_sin_vida') {
    valorMunicipio = totalMunicipio > 0 ? (sinVidaMunicipio / totalMunicipio) * 100 : 0;
  } else if (metricaKey === 'tasa_desaparecidos') {
    valorMunicipio = totalMunicipio > 0 ? (desaparecidosMunicipio / totalMunicipio) * 100 : 0;
  } else if (metricaKey === 'total_casos') {
    valorMunicipio = totalMunicipio;
  } else if (metricaKey === 'casos_con_vida') {
    valorMunicipio = conVidaMunicipio;
  }

  const promedioInfo = document.getElementById('promedioEstatalInfo');
  if (promedioInfo) {
    promedioInfo.innerHTML = `
      <span class="benchmark-valor">${formatearValorMetrica(valorEstado, metricaKey)}</span><br>
      <span style="color: #666; font-size: 10px;">
        Total: ${totalEstado.toLocaleString()} casos
      </span>
    `;
  }

  const municipioLabel = document.getElementById('municipioBenchmarkLabel');
  if (municipioLabel) municipioLabel.innerHTML = `üìç ${municipio}`;

  const municipioInfo = document.getElementById('municipioBenchmarkInfo');
  if (municipioInfo) {
    const diff = valorMunicipio - valorEstado;

    let esSuperior, esSimilar;
    if (metricaKey.includes('tasa')) {
      esSuperior = Math.abs(diff) > 1;
      esSimilar = Math.abs(diff) <= 1;
    } else {
      const diffPorcentual = totalEstado > 0 ? (diff / totalEstado) * 100 : 0;
      esSuperior = Math.abs(diffPorcentual) > 5;
      esSimilar = Math.abs(diffPorcentual) <= 5;
    }

    let simbolo, color, texto;
    const invertir = (metricaKey === 'tasa_sin_vida' || metricaKey === 'tasa_desaparecidos');

    if (esSimilar) {
      simbolo = '‚ñ†';
      color = '#f39c12';
      texto = 'Similar';
    } else {
      const esPositivo = diff > 0;
      if (invertir) {
        simbolo = esPositivo ? '‚ñº' : '‚ñ≤';
        color = esPositivo ? '#e74c3c' : '#27ae60';
        texto = esPositivo ? 'Superior (negativo)' : 'Inferior (positivo)';
      } else {
        simbolo = esPositivo ? '‚ñ≤' : '‚ñº';
        color = esPositivo ? '#27ae60' : '#e74c3c';
        texto = esPositivo ? 'Superior' : 'Inferior';
      }
    }

    let detalles = '';
    if (metricaKey === 'tasa_con_vida') {
      detalles = `${conVidaMunicipio.toLocaleString()} con vida de ${totalMunicipio.toLocaleString()}`;
    } else if (metricaKey === 'tasa_sin_vida') {
      detalles = `${sinVidaMunicipio.toLocaleString()} sin vida de ${totalMunicipio.toLocaleString()}`;
    } else if (metricaKey === 'tasa_desaparecidos') {
      detalles = `${desaparecidosMunicipio.toLocaleString()} desaparecidos de ${totalMunicipio.toLocaleString()}`;
    } else if (metricaKey === 'casos_con_vida') {
      detalles = `${conVidaMunicipio.toLocaleString()} casos con vida`;
    } else {
      detalles = `${totalMunicipio.toLocaleString()} casos totales`;
    }

    municipioInfo.innerHTML = `
      <span class="benchmark-valor">${formatearValorMetrica(valorMunicipio, metricaKey)}</span><br>
      <span style="color: ${color}; font-size: 11px;">
        ${simbolo} ${texto} al promedio
      </span><br>
      <span style="font-size: 10px; color: #666;">
        ${detalles}
      </span>
    `;
  }
}

function formatearValorMetrica(valor, metricaKey) {
  if (metricaKey.includes('tasa')) {
    return `${valor.toFixed(1)}%`;
  } else {
    return valor.toLocaleString();
  }
}

function generarGraficaDual() {
  const catPrincipal = document.getElementById('categoriaPrincipal')?.value;
  const catSecundaria = document.getElementById('categoriaSecundaria')?.value;

  if (catPrincipal === catSecundaria) {
    alert("Las categor√≠as deben ser diferentes");
    return null;
  }

  const municipios = obtenerValoresSeleccionados('municipiosComparacion');
  const anios = obtenerValoresSeleccionados('aniosComparacion');
  const sexos = obtenerValoresSeleccionados('sexoComparacion');
  const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
  const estados = obtenerValoresSeleccionados('estadoComparacion');
  const condiciones = obtenerValoresSeleccionados('condicionComparacion');

  if (municipios.length === 0 || anios.length === 0) {
    alert("Selecciona al menos un municipio y un a√±o");
    return null;
  }

  let datosFiltrados = datos.filter(d =>
    municipios.includes(d.municipio) &&
    anios.includes(String(d.a√±o)) &&
    (sexos.length === 0 || sexos.includes(d.sexo)) &&
    (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
    (estados.length === 0 || estados.includes(d.estatus_persona)) &&
    (condiciones.length === 0 || condiciones.includes(d.condicion_localizacion))
  );

  if (datosFiltrados.length === 0) return null;

  let valoresPrincipal = [...new Set(datosFiltrados.map(d => d[catPrincipal]))]
    .filter(v => v != null);
  let valoresSecundaria = [...new Set(datosFiltrados.map(d => d[catSecundaria]))]
    .filter(v => v != null);

  if (catPrincipal === 'condicion_localizacion') {
    const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
    valoresPrincipal.sort((a,b) => orden.indexOf(a) - orden.indexOf(b));
  }
  if (catSecundaria === 'condicion_localizacion') {
    const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
    valoresSecundaria.sort((a,b) => orden.indexOf(a) - orden.indexOf(b));
  }

  const valoresSecundariaLimitados = valoresSecundaria.slice(0, 8);
  const labels = valoresPrincipal;
  const datasets = valoresSecundariaLimitados.map((valor, index) => {
    const data = labels.map(label => {
      return datosFiltrados
        .filter(d => d[catPrincipal] === label && d[catSecundaria] === valor)
        .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    });
    return {
      label: valor,
      data,
      backgroundColor: BASE_COLORS[index % BASE_COLORS.length],
      borderWidth: 1
    };
  }).filter(ds => ds.data.some(v => v > 0));

  if (datasets.length === 0) return null;

  const titulo = `Comparaci√≥n: ${catPrincipal} (eje X) vs ${catSecundaria} (colores)`;
  return { labels, datasets, titulo, tipo: 'bar' };
}

function generarGraficaDispersion() {
  const municipios = obtenerValoresSeleccionados('municipiosComparacion');
  const anios = obtenerValoresSeleccionados('aniosComparacion');
  const sexos = obtenerValoresSeleccionados('sexoComparacion');
  const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
  const estados = obtenerValoresSeleccionados('estadoComparacion');
  const condiciones = obtenerValoresSeleccionados('condicionComparacion');

  const metricaSelector = document.getElementById('metricaDispersion');
  const metricaKey = metricaSelector?.value || 'tasa_con_vida';

  if (municipios.length === 0 || anios.length === 0) {
    alert("Selecciona al menos un municipio y un a√±o.");
    return null;
  }

  const filtroBase = d =>
    municipios.includes(d.municipio) &&
    anios.includes(String(d.a√±o)) &&
    (sexos.length === 0 || sexos.includes(d.sexo)) &&
    (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
    (estados.length === 0 || estados.includes(d.estatus_persona));

  const datosMunicipios = [];

  municipios.forEach(municipio => {
    const datosMun = datos.filter(d =>
      d.municipio === municipio && filtroBase(d)
    );

    if (datosMun.length === 0) return;

    const totalCasos = datosMun.reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const conVida = datosMun
      .filter(d => d.condicion_localizacion === "CON VIDA" || d.condicion_localizacion === "Con vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const sinVida = datosMun
      .filter(d => d.condicion_localizacion === "SIN VIDA" || d.condicion_localizacion === "Sin vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const desaparecidos = datosMun
      .filter(d => d.condicion_localizacion === "Desaparecida" || d.condicion_localizacion === "DESAPARECIDA")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

    let valorMetrica;
    if (metricaKey === 'tasa_con_vida') {
      valorMetrica = totalCasos > 0 ? (conVida / totalCasos) * 100 : 0;
    } else if (metricaKey === 'tasa_sin_vida') {
      valorMetrica = totalCasos > 0 ? (sinVida / totalCasos) * 100 : 0;
    } else if (metricaKey === 'tasa_desaparecidos') {
      valorMetrica = totalCasos > 0 ? (desaparecidos / totalCasos) * 100 : 0;
    } else if (metricaKey === 'total_casos') {
      valorMetrica = totalCasos;
    } else if (metricaKey === 'casos_con_vida') {
      valorMetrica = conVida;
    }

    const a√±osUnicos = [...new Set(datosMun.map(d => d.a√±o))].length;

    datosMunicipios.push({
      municipio,
      totalCasos,
      valorMetrica: Math.round(valorMetrica * 10) / 10,
      a√±osDatos: a√±osUnicos,
      conVida,
      sinVida,
      desaparecidos,
      color: BASE_COLORS[municipios.indexOf(municipio) % BASE_COLORS.length]
    });
  });

  if (datosMunicipios.length === 0) return null;

  datosMunicipios.sort((a, b) => b.totalCasos - a.totalCasos);

  let nombreMetrica = '';
  if (metricaKey === 'tasa_con_vida') nombreMetrica = '% con vida';
  else if (metricaKey === 'tasa_sin_vida') nombreMetrica = '% sin vida';
  else if (metricaKey === 'tasa_desaparecidos') nombreMetrica = '% desaparecidos';
  else if (metricaKey === 'total_casos') nombreMetrica = 'Total casos';
  else if (metricaKey === 'casos_con_vida') nombreMetrica = 'Casos con vida';

  const datasets = [{
    label: 'Municipios',
    data: datosMunicipios.map(d => ({
      x: d.totalCasos,
      y: d.valorMetrica,
      municipio: d.municipio,
      a√±os: d.a√±osDatos,
      conVida: d.conVida,
      sinVida: d.sinVida,
      desaparecidos: d.desaparecidos,
      totalCasos: d.totalCasos,
      metrica: nombreMetrica,
      valorFormateado: metricaKey.includes('tasa') ?
        `${d.valorMetrica}%` :
        d.valorMetrica.toLocaleString()
    })),
    backgroundColor: datosMunicipios.map(d => d.color),
    borderColor: datosMunicipios.map(d => d.color),
    borderWidth: 2,
    pointRadius: 8,
    pointHoverRadius: 12,
    pointBorderColor: '#ffffff',
    pointBorderWidth: 2
  }];

  const titulo = `Dispersi√≥n: Casos totales vs ${nombreMetrica} (${anios.length} a√±o${anios.length > 1 ? 's' : ''})`;
  return { labels: [], datasets, titulo, tipo: 'scatter' };
}

function generarGraficaBenchmark(municipio) {
  const anios = obtenerValoresSeleccionados('aniosComparacion');
  const sexos = obtenerValoresSeleccionados('sexoComparacion');
  const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
  const estados = obtenerValoresSeleccionados('estadoComparacion');
  const condiciones = obtenerValoresSeleccionados('condicionComparacion');

  if (anios.length === 0) {
    alert("Selecciona al menos un a√±o para la comparaci√≥n.");
    return null;
  }

  const metricaSelector = document.getElementById('metricaBenchmark');
  const metricaKey = metricaSelector?.value || 'tasa_con_vida';

  const a√±osOrdenados = anios.sort((a, b) => a - b);

  const filtroBase = d =>
    (sexos.length === 0 || sexos.includes(d.sexo)) &&
    (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
    (estados.length === 0 || estados.includes(d.estatus_persona));

  const datosMunicipio = a√±osOrdenados.map(a√±o => {
    const datosA√±o = datos.filter(d =>
      String(d.a√±o) === String(a√±o) &&
      d.municipio === municipio &&
      filtroBase(d)
    );

    const total = datosA√±o.reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const conVida = datosA√±o
      .filter(d => d.condicion_localizacion === "CON VIDA" || d.condicion_localizacion === "Con vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const sinVida = datosA√±o
      .filter(d => d.condicion_localizacion === "SIN VIDA" || d.condicion_localizacion === "Sin vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const desaparecidos = datosA√±o
      .filter(d => d.condicion_localizacion === "Desaparecida" || d.condicion_localizacion === "DESAPARECIDA")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

    let valor;
    if (metricaKey === 'tasa_con_vida') {
      valor = total > 0 ? (conVida / total) * 100 : 0;
    } else if (metricaKey === 'tasa_sin_vida') {
      valor = total > 0 ? (sinVida / total) * 100 : 0;
    } else if (metricaKey === 'tasa_desaparecidos') {
      valor = total > 0 ? (desaparecidos / total) * 100 : 0;
    } else if (metricaKey === 'total_casos') {
      valor = total;
    } else if (metricaKey === 'casos_con_vida') {
      valor = conVida;
    }

    return { a√±o, valor, total, conVida, sinVida, desaparecidos };
  });

  const datosEstado = a√±osOrdenados.map(a√±o => {
    const datosA√±o = datos.filter(d =>
      String(d.a√±o) === String(a√±o) &&
      filtroBase(d)
    );

    const total = datosA√±o.reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const conVida = datosA√±o
      .filter(d => d.condicion_localizacion === "CON VIDA" || d.condicion_localizacion === "Con vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const sinVida = datosA√±o
      .filter(d => d.condicion_localizacion === "SIN VIDA" || d.condicion_localizacion === "Sin vida")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);
    const desaparecidos = datosA√±o
      .filter(d => d.condicion_localizacion === "Desaparecida" || d.condicion_localizacion === "DESAPARECIDA")
      .reduce((sum, d) => sum + (Number(d.total) || 0), 0);

    let valor;
    if (metricaKey === 'tasa_con_vida') {
      valor = total > 0 ? (conVida / total) * 100 : 0;
    } else if (metricaKey === 'tasa_sin_vida') {
      valor = total > 0 ? (sinVida / total) * 100 : 0;
    } else if (metricaKey === 'tasa_desaparecidos') {
      valor = total > 0 ? (desaparecidos / total) * 100 : 0;
    } else if (metricaKey === 'total_casos') {
      valor = total;
    } else if (metricaKey === 'casos_con_vida') {
      valor = conVida;
    }

    return { a√±o, valor, total };
  });

  const labels = a√±osOrdenados;

  let nombreMetrica = '';
  if (metricaKey === 'tasa_con_vida') nombreMetrica = '% Localizados con vida';
  else if (metricaKey === 'tasa_sin_vida') nombreMetrica = '% Localizados sin vida';
  else if (metricaKey === 'tasa_desaparecidos') nombreMetrica = '% Desaparecidos';
  else if (metricaKey === 'total_casos') nombreMetrica = 'Total de casos';
  else if (metricaKey === 'casos_con_vida') nombreMetrica = 'Casos con vida';

  let colorMunicipio;
  if (metricaKey === 'tasa_con_vida') colorMunicipio = '#27ae60';
  else if (metricaKey === 'tasa_sin_vida') colorMunicipio = '#e74c3c';
  else if (metricaKey === 'tasa_desaparecidos') colorMunicipio = '#f39c12';
  else colorMunicipio = '#3498db';

  const datasets = [
    {
      label: `${municipio} - ${nombreMetrica}`,
      data: datosMunicipio.map(d => Number(d.valor.toFixed(1))),
      borderColor: colorMunicipio,
      backgroundColor: `${colorMunicipio}20`,
      borderWidth: 3,
      tension: 0.3,
      fill: false,
      pointRadius: 6,
      pointHoverRadius: 10,
      pointBackgroundColor: colorMunicipio
    },
    {
      label: `Promedio estatal - ${nombreMetrica}`,
      data: datosEstado.map(d => Number(d.valor.toFixed(1))),
      borderColor: '#34495e',
      backgroundColor: 'rgba(52, 73, 94, 0.1)',
      borderWidth: 3,
      tension: 0.3,
      fill: false,
      pointRadius: 6,
      pointHoverRadius: 10,
      borderDash: [5, 5],
      pointBackgroundColor: '#34495e'
    }
  ];

  const titulo = `Benchmark: ${municipio} vs Promedio estatal (${nombreMetrica})`;
  return { labels, datasets, titulo, tipo: 'line' };
}

function generarGrafica() {
  try {
    const dualActivo = document.getElementById('activarSelectorDual')?.checked || false;
    const benchmarkActivo = document.getElementById('activarBenchmark')?.checked || false;
    const dispersionActiva = document.getElementById('activarDispersion')?.checked || false;

    let resultado = null;

    // Solo un modo puede estar activo a la vez
    if (dualActivo && !benchmarkActivo && !dispersionActiva) {
      resultado = generarGraficaDual();
    } else if (!dualActivo && benchmarkActivo && !dispersionActiva) {
      const municipio = document.getElementById('municipioBenchmark')?.value;
      if (!municipio) {
        alert("Selecciona un municipio para la comparaci√≥n.");
        return;
      }
      resultado = generarGraficaBenchmark(municipio);
    } else if (!dualActivo && !benchmarkActivo && dispersionActiva) {
      resultado = generarGraficaDispersion();
    }

    if (resultado) {
      renderChart(resultado.labels, resultado.datasets, resultado.titulo, resultado.tipo);
      
      // Actualizar resumen despu√©s de generar gr√°fica
      setTimeout(actualizarResumenSeleccion, 100);
      return;
    }

    // Si no hay modo avanzado activo, generar gr√°fica normal
    generarGraficaNormal();

  } catch (error) {
    console.error("Error generando gr√°fica:", error);
    alert(`Error: ${error.message}`);
  }
}

function generarGraficaNormal() {
  const municipios = obtenerValoresSeleccionados('municipiosComparacion');
  const anios = obtenerValoresSeleccionados('aniosComparacion');
  const sexos = obtenerValoresSeleccionados('sexoComparacion');
  const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
  const estados = obtenerValoresSeleccionados('estadoComparacion');
  const condiciones = obtenerValoresSeleccionados('condicionComparacion');

  if (municipios.length === 0) { alert("Selecciona al menos un municipio."); return; }
  if (anios.length === 0) { alert("Selecciona al menos un a√±o."); return; }

  let datosFiltrados = datos.filter(d =>
    municipios.includes(d.municipio) &&
    anios.includes(String(d.a√±o)) &&
    (sexos.length === 0 || sexos.includes(d.sexo)) &&
    (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
    (estados.length === 0 || estados.includes(d.estatus_persona)) &&
    (condiciones.length === 0 || condiciones.includes(d.condicion_localizacion))
  );

  if (datosFiltrados.length === 0) {
    alert("No hay datos disponibles para los filtros seleccionados.");
    return;
  }

  let categoriaActiva = null;
  let valoresCategoria = [];
  let campoCategoria = '';

  if (condiciones.length > 0) {
    categoriaActiva = 'Condici√≥n';
    valoresCategoria = condiciones;
    campoCategoria = 'condicion_localizacion';
  } else if (estados.length > 0) {
    categoriaActiva = 'Estado';
    valoresCategoria = estados;
    campoCategoria = 'estatus_persona';
  } else if (sexos.length > 0) {
    categoriaActiva = 'Sexo';
    valoresCategoria = sexos;
    campoCategoria = 'sexo';
  } else if (rangosEdad.length > 0) {
    categoriaActiva = 'Edad';
    valoresCategoria = rangosEdad;
    campoCategoria = 'rango_edad';
  }

  let labels, datasets;

  if (anios.length > 1) {
    labels = anios.sort((a, b) => a - b);
    datasets = [];

    if (categoriaActiva) {
      if (campoCategoria === 'condicion_localizacion') {
        const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
        valoresCategoria = [...valoresCategoria].sort((a, b) => {
          const ia = orden.indexOf(a);
          const ib = orden.indexOf(b);
          if (ia === -1 && ib === -1) return 0;
          if (ia === -1) return 1;
          if (ib === -1) return -1;
          return ia - ib;
        });
      }

      valoresCategoria.forEach(valor => {
        const data = labels.map(anio =>
          datosFiltrados
            .filter(d => String(d.a√±o) === String(anio) && d[campoCategoria] === valor)
            .reduce((sum, d) => sum + (Number(d.total) || 0), 0)
        );
        if (data.some(v => v > 0)) {
          datasets.push({ label: valor, data, borderWidth: 2, tension: 0.3, fill: chartType.includes('area') });
        }
      });
    } else {
      datasets.push({
        label: 'Total',
        data: labels.map(anio => datosFiltrados.filter(d => String(d.a√±o) === String(anio)).reduce((sum, d) => sum + (Number(d.total) || 0), 0)),
        borderWidth: 2, tension: 0.3, fill: chartType.includes('area')
      });
    }
  }
  else if (municipios.length > 1) {
    labels = municipios;
    datasets = [];

    if (categoriaActiva) {
      if (campoCategoria === 'condicion_localizacion') {
        const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
        valoresCategoria = [...valoresCategoria].sort((a, b) => {
          const ia = orden.indexOf(a);
          const ib = orden.indexOf(b);
          if (ia === -1 && ib === -1) return 0;
          if (ia === -1) return 1;
          if (ib === -1) return -1;
          return ia - ib;
        });
      }

      valoresCategoria.forEach(valor => {
        const data = labels.map(municipio =>
          datosFiltrados
            .filter(d => d.municipio === municipio && d[campoCategoria] === valor)
            .reduce((sum, d) => sum + (Number(d.total) || 0), 0)
        );
        if (data.some(v => v > 0)) {
          datasets.push({ label: valor, data });
        }
      });
    } else {
      datasets.push({
        label: 'Total',
        data: labels.map(municipio => datosFiltrados.filter(d => d.municipio === municipio).reduce((sum, d) => sum + (Number(d.total) || 0), 0))
      });
    }
  }
  else {
    if (categoriaActiva) {
      labels = valoresCategoria;
      if (campoCategoria === 'condicion_localizacion') {
        const orden = ['CON VIDA', 'Desaparecida', 'SIN VIDA', 'Con vida', 'DESAPARECIDA', 'Sin vida'];
        labels = [...labels].sort((a, b) => {
          const ia = orden.indexOf(a);
          const ib = orden.indexOf(b);
          if (ia === -1 && ib === -1) return 0;
          if (ia === -1) return 1;
          if (ib === -1) return -1;
          return ia - ib;
        });
      }
      datasets = [{
        label: categoriaActiva,
        data: labels.map(valor => datosFiltrados.filter(d => d[campoCategoria] === valor).reduce((sum, d) => sum + (Number(d.total) || 0), 0))
      }];
    } else {
      labels = ['Total'];
      datasets = [{
        label: 'Casos',
        data: [datosFiltrados.reduce((sum, d) => sum + (Number(d.total) || 0), 0)]
      }];
    }
  }

  if (!datasets || datasets.length === 0) {
    alert("No hay datos para mostrar con los filtros seleccionados.");
    return;
  }

  const titulo = generarTituloGrafica({ municipios, anios, sexos, rangosEdad, estados, condiciones });
  renderChart(labels, datasets, titulo, chartType);
  
  // Actualizar resumen despu√©s de generar gr√°fica
  setTimeout(actualizarResumenSeleccion, 100);
}

function generarTituloGrafica(filtros) {
  const partes = [];
  if (filtros.municipios.length === 1) partes.push(`Municipio: ${filtros.municipios[0]}`);
  else if (filtros.municipios.length > 1) partes.push(`${filtros.municipios.length} municipios`);

  if (filtros.anios.length === 1) partes.push(`A√±o: ${filtros.anios[0]}`);
  else if (filtros.anios.length > 1) partes.push(`${filtros.anios.length} a√±os`);

  if (filtros.sexos.length === 1) partes.push(`Sexo: ${filtros.sexos[0]}`);
  else if (filtros.sexos.length > 1) partes.push(`Ambos sexos`);

  if (filtros.rangosEdad.length === 1) partes.push(`Edad: ${filtros.rangosEdad[0]}`);
  else if (filtros.rangosEdad.length > 1) partes.push(`${filtros.rangosEdad.length} rangos`);

  if (filtros.estados.length === 1) partes.push(`Estado: ${filtros.estados[0]}`);
  else if (filtros.estados.length > 1) partes.push(`${filtros.estados.length} estados`);

  if (filtros.condiciones.length === 1) partes.push(`Condici√≥n: ${filtros.condiciones[0]}`);
  else if (filtros.condiciones.length > 1) partes.push(`${filtros.condiciones.length} condiciones`);

  return partes.join(' | ') || 'Todos los filtros';
}

function renderChart(labels, datasets, titulo, tipoForzado = null) {
  const ctx = document.getElementById('grafica');
  if (chartAnalisis) chartAnalisis.destroy();


  let subtitulo = '';

  try {
    // Obtener valores seleccionados
    const municipios = obtenerValoresSeleccionados('municipiosComparacion');
    const anios = obtenerValoresSeleccionados('aniosComparacion');
    const sexos = obtenerValoresSeleccionados('sexoComparacion');
    const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
    const estados = obtenerValoresSeleccionados('estadoComparacion');
    const condiciones = obtenerValoresSeleccionados('condicionComparacion');

    // ===== MUNICIPIOS =====
    if (municipios.length === 1) {
      subtitulo += `${municipios[0]}`;
    } else if (municipios.length === 2) {
      subtitulo += `${municipios[0]} y ${municipios[1]}`;
    } else if (municipios.length === 3) {
      subtitulo += `${municipios[0]}, ${municipios[1]} y ${municipios[2]}`;
    } else if (municipios.length > 3) {
      subtitulo += `${municipios[0]}, ${municipios[1]}, ${municipios[2]} y ${municipios.length - 3} m√°s`;
    }

    // ===== A√ëOS =====
    if (anios.length === 1) {
      subtitulo += ` ¬∑ ${anios[0]}`;
    } else if (anios.length === 2) {
      const aniosOrd = [...anios].sort();
      subtitulo += ` ¬∑ ${aniosOrd[0]} y ${aniosOrd[1]}`;
    } else if (anios.length === 3) {
      const aniosOrd = [...anios].sort();
      subtitulo += ` ¬∑ ${aniosOrd[0]}, ${aniosOrd[1]} y ${aniosOrd[2]}`;
    } else if (anios.length > 3) {
      const aniosOrd = [...anios].sort();
      subtitulo += ` ¬∑ ${aniosOrd[0]}, ${aniosOrd[1]}, ${aniosOrd[2]} y ${anios.length - 3} m√°s`;
    }

    // ===== SEXOS =====
    if (sexos.length === 1) {
      subtitulo += ` ¬∑ ${sexos[0]}`;
    } else if (sexos.length === 2) {
      subtitulo += ` ¬∑ Ambos sexos (${sexos.join(' y ')})`;
    }

    // ===== EDADES =====
    if (rangosEdad.length === 1) {
      subtitulo += ` ¬∑ ${rangosEdad[0]}`;
    } else if (rangosEdad.length === 2) {
      subtitulo += ` ¬∑ ${rangosEdad.join(' y ')}`;
    } else if (rangosEdad.length === 3) {
      subtitulo += ` ¬∑ ${rangosEdad[0]}, ${rangosEdad[1]} y ${rangosEdad[2]}`;
    } else if (rangosEdad.length > 3) {
      subtitulo += ` ¬∑ ${rangosEdad[0]}, ${rangosEdad[1]}, ${rangosEdad[2]} y ${rangosEdad.length - 3} m√°s`;
    }

    // ===== CONDICIONES =====
    if (condiciones.length === 1) {
      subtitulo += ` ¬∑ ${condiciones[0]}`;
    } else if (condiciones.length === 2) {
      subtitulo += ` ¬∑ ${condiciones.join(' y ')}`;
    } else if (condiciones.length === 3) {
      // Verificar si son las 3 condiciones principales
      const tieneConVida = condiciones.some(c => c === "CON VIDA" || c === "Con vida");
      const tieneSinVida = condiciones.some(c => c === "SIN VIDA" || c === "Sin vida");
      const tieneDesaparecida = condiciones.some(c => c === "DESAPARECIDA" || c === "Desaparecida");

      if (tieneConVida && tieneSinVida && tieneDesaparecida) {
        subtitulo += ` ¬∑ Todas las condiciones`;
      } else {
        subtitulo += ` ¬∑ ${condiciones.join(', ')}`;
      }
    }

    // ===== ESTADOS =====
    if (estados.length === 1) {
      subtitulo += ` ¬∑ ${estados[0]}`;
    } else if (estados.length === 2) {
      subtitulo += ` ¬∑ ${estados.join(' y ')}`;
    } else if (estados.length > 2) {
      subtitulo += ` ¬∑ ${estados[0]}, ${estados[1]} y ${estados.length - 2} m√°s`;
    }

    // Si no hay subt√≠tulo, poner uno gen√©rico
    if (subtitulo === '') {
      subtitulo = 'üìä Selecciona filtros para ver detalles';
    }

  } catch (error) {
    console.error("Error generando subt√≠tulo:", error);
    subtitulo = 'üìä Genera una gr√°fica para ver detalles';
  }

  document.getElementById('resumen').innerText = titulo;

  let type = tipoForzado || chartType;
  let stacked = false;
  let fillArea = false;

  if (type === 'scatter') {
    let nombreMetricaY = 'M√©trica';
    let esPorcentaje = false;

    if (datasets && datasets[0] && datasets[0].data && datasets[0].data.length > 0) {
      const primerPunto = datasets[0].data[0];
      if (primerPunto && primerPunto.metrica) {
        nombreMetricaY = primerPunto.metrica;
      }
      esPorcentaje = nombreMetricaY.includes('%') ||
                    (primerPunto && primerPunto.y <= 100 && primerPunto.y >= 0 &&
                     (nombreMetricaY.includes('tasa') || nombreMetricaY.includes('%')));
    }

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'linear',
          position: 'bottom',
          title: {
            display: true,
            text: 'Total de casos',
            font: { weight: 'bold', size: 11 }
          },
          ticks: {
            callback: function(v) {
              return v >= 1000 ? (v/1000).toFixed(1) + 'k' : v;
            }
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: nombreMetricaY,
            font: { weight: 'bold', size: 11 }
          },
          ticks: {
            callback: function(v) {
              if (esPorcentaje) {
                return v + '%';
              }
              return v >= 1000 ? (v/1000).toFixed(1) + 'k' : v;
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const d = context.raw;
              if (!d) return [];

              const mostrarComoPorcentaje = esPorcentaje ||
                                           (d.y <= 100 && d.y >= 0 &&
                                            (d.metrica?.includes('%') || d.metrica?.includes('tasa')));

              const lines = [
                `${d.municipio || 'Desconocido'}`,
                `Casos totales: ${(d.totalCasos || d.x || 0).toLocaleString()}`,
                `${d.metrica || 'M√©trica'}: ${mostrarComoPorcentaje ? d.y.toFixed(1) + '%' : (d.y || 0).toLocaleString()}`,
                `üü¢ Con vida: ${(d.conVida || 0).toLocaleString()}`,
                `üî¥ Sin vida: ${(d.sinVida || 0).toLocaleString()}`,
                `üü° Desaparecidos: ${(d.desaparecidos || 0).toLocaleString()}`,
                `A√±os con datos: ${d.a√±os || 1}`
              ];
              return lines;
            }
          },
          backgroundColor: 'rgba(0,0,0,0.85)',
          titleColor: '#fff',
          bodyColor: '#fff',
          titleFont: { size: 12, weight: 'bold' },
          bodyFont: { size: 11 },
          padding: 10,
          cornerRadius: 6
        },
        title: {
          display: true,
          text: [titulo, subtitulo],
          font: {
            size: 12,
            weight: 'bold',
            lineHeight: 1.5
          },
          padding: { top: 10, bottom: 15 },
          color: ['#2c3e50', '#666666']
        },
        legend: {
          display: true
        },
        datalabels: {
          display: false
        },
        watermark: {
          text: 'rys2000dev',
          fontSize: 26,
          opacity: 0.07,
          angle: 0
        }
      }
    };

    if (esPorcentaje) {
      options.scales.y.max = 100;
    }

    try {
      chartAnalisis = new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options
      });
    } catch (error) {
      console.error("Error creando gr√°fica scatter:", error);
      alert("Error al crear la gr√°fica de dispersi√≥n. Revisa la consola para m√°s detalles.");
    }
    return;
  }

  if (type === "area") { type = "line"; fillArea = true; }
  if (type === "stackedArea") { type = "line"; fillArea = true; stacked = true; }
  if (type === "stackedBar") { type = "bar"; stacked = true; }

  const enhancedDatasets = apply3DEffects(datasets, type, fillArea);
  let finalLabels = labels;
  let finalDatasets = enhancedDatasets;

  if (type === 'pie' || type === 'doughnut') {
    if (enhancedDatasets.length > 1) {
      const dataConsolidada = new Array(labels.length).fill(0);
      enhancedDatasets.forEach(dataset => {
        dataset.data.forEach((value, index) => { dataConsolidada[index] += value; });
      });
      finalDatasets = [{
        label: 'Total',
        data: dataConsolidada,
        backgroundColor: generarColores(labels.length),
        borderColor: '#ffffff',
        borderWidth: 2
      }];
    }
  }

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    indexAxis: 'x',
    radius: (type === 'pie' || type === 'doughnut') ? '80%' : '100%',
    animation: { duration: 800, easing: 'easeOutQuart' },
    scales: (type === 'pie' || type === 'doughnut') ? {} : {
      x: { stacked, ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 0 }, grid: { color: 'rgba(0,0,0,0.1)' } },
      y: { stacked, beginAtZero: true, grace: '10%', ticks: { font: { size: 10 }, callback: v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v }, grid: { color: 'rgba(0,0,0,0.1)' } }
    },
    plugins: {
      legend: { display: datasets.length > 1, position: 'top', labels: { font: { size: 10 }, usePointStyle: true, pointStyle: 'rect', padding: 20 } },
      title: {
        display: true,
        text: [titulo, subtitulo],
        font: {
          size: 12,
          weight: 'bold',
          lineHeight: 1.5
        },
        padding: { top: 10, bottom: 15 },
        color: ['#2c3e50', '#666666']
      },
      tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.75)', titleColor: '#fff', bodyColor: '#fff', displayColors: true },
      watermark: { text: 'rys2000dev', fontSize: 26, opacity: 0.07, angle: 0 },
      datalabels: {
        display: ctx => typeof ctx.dataset.data[ctx.dataIndex] === 'number' && ctx.dataset.data[ctx.dataIndex] > 0 && datasets.length <= 5,
        formatter: v => v >= 1000 ? (v/1000).toFixed(1)+'k' : v.toLocaleString(),
        color: ctx => ctx.chart.config.type === 'line' ? '#fff' : '#000',
        font: ctx => ctx.chart.config.type === 'line' ? { weight: 'bold', size: 10 } : { weight: 'bold', size: 11 },
        anchor: ctx => ctx.chart.config.type === 'line' ? 'center' : (ctx.chart.options.scales?.x?.stacked ? 'center' : 'end'),
        align: ctx => ctx.chart.config.type === 'line' ? 'center' : (ctx.chart.options.scales?.x?.stacked ? 'center' : 'top'),
        offset: ctx => ctx.chart.config.type === 'line' ? 0 : 4,
        clamp: true
      }
    }
  };

  try {
    chartAnalisis = new Chart(ctx, {
      type,
      data: { labels: finalLabels, datasets: finalDatasets },
      options,
      plugins: [ChartDataLabels]
    });
  } catch (error) {
    console.error("Error creando gr√°fica:", error);
    alert(`Error al crear la gr√°fica: ${error.message}`);
  }
}

function generarColores(cantidad) {
  const colores = [];
  const hueStep = 360 / (cantidad || 1);
  for (let i = 0; i < cantidad; i++) colores.push(`hsl(${i * hueStep}, 70%, 60%)`);
  return colores;
}

class SimplePredictor {
  constructor() {
    this.estadisticas = null;
    this.isTrained = false;
  }

  prepararEstadisticas(datos) {
    const stats = {
      porMunicipio: {}, porSexo: {}, porEdad: {}, porMeses: {}, porSexoEdad: {},
      general: { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 }
    };

    const datosCompletos = datos.filter(d =>
      d.sexo && d.rango_edad && d.municipio && d.estatus_persona && d.condicion_localizacion && d.meses != null
    );

    if (datosCompletos.length === 0) return this.crearEstadisticasBasicas();

    datosCompletos.forEach(d => {
      stats.general.total++;
      const condicion = this.normalizarTexto(d.condicion_localizacion);
      if (condicion === "CON VIDA") stats.general.conVida++;
      else if (condicion === "SIN VIDA") stats.general.sinVida++;
      else if (condicion === "DESAPARECIDA") stats.general.desaparecida++;

      const municipio = this.normalizarTexto(d.municipio);
      const sexo = this.normalizarTexto(d.sexo);
      const rangoEdad = d.rango_edad;
      const claveSexoEdad = `${sexo}_${rangoEdad}`;
      const grupoMeses = Math.min(10, Math.floor((parseInt(d.meses) || 0) / 6));

      if (!stats.porMunicipio[municipio]) stats.porMunicipio[municipio] = { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 };
      stats.porMunicipio[municipio].total++;
      if (condicion === "CON VIDA") stats.porMunicipio[municipio].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porMunicipio[municipio].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porMunicipio[municipio].sinVida++;

      if (!stats.porSexo[sexo]) stats.porSexo[sexo] = { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 };
      stats.porSexo[sexo].total++;
      if (condicion === "CON VIDA") stats.porSexo[sexo].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porSexo[sexo].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porSexo[sexo].sinVida++;

      if (!stats.porEdad[rangoEdad]) stats.porEdad[rangoEdad] = { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 };
      stats.porEdad[rangoEdad].total++;
      if (condicion === "CON VIDA") stats.porEdad[rangoEdad].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porEdad[rangoEdad].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porEdad[rangoEdad].sinVida++;

      if (!stats.porSexoEdad[claveSexoEdad]) stats.porSexoEdad[claveSexoEdad] = { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 };
      stats.porSexoEdad[claveSexoEdad].total++;
      if (condicion === "CON VIDA") stats.porSexoEdad[claveSexoEdad].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porSexoEdad[claveSexoEdad].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porSexoEdad[claveSexoEdad].sinVida++;

      if (!stats.porMeses[grupoMeses]) stats.porMeses[grupoMeses] = { total: 0, conVida: 0, desaparecida: 0, sinVida: 0 };
      stats.porMeses[grupoMeses].total++;
      if (condicion === "CON VIDA") stats.porMeses[grupoMeses].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porMeses[grupoMeses].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porMeses[grupoMeses].sinVida++;
    });

    this.calcularProbabilidades(stats);
    this.estadisticas = stats;
    this.isTrained = true;
    return stats;
  }

  normalizarTexto(texto) {
    if (!texto) return "";
    return texto.normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "").toUpperCase().trim();
  }

  crearEstadisticasBasicas() {
    const stats = {
      porMunicipio: {},
      porSexo: {
        'MUJER': { total: 100, conVida: 35, desaparecida: 40, sinVida: 25, probConVida: 0.35, probDesaparecida: 0.4, probSinVida: 0.25 },
        'HOMBRE': { total: 100, conVida: 30, desaparecida: 45, sinVida: 25, probConVida: 0.3, probDesaparecida: 0.45, probSinVida: 0.25 }
      },
      porEdad: {}, porMeses: {}, porSexoEdad: {},
      general: { total: 200, conVida: 65, desaparecida: 85, sinVida: 50, probConVida: 0.325, probDesaparecida: 0.425, probSinVida: 0.25 }
    };

    const rangosEdad = ['0-4','5-9','10-14','15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74'];
    rangosEdad.forEach(rango => {
      const edadNum = parseInt(rango.split('-')[0]);
      let probConVida, probDesaparecida, probSinVida;
      if (edadNum < 20) { probConVida = 0.35; probDesaparecida = 0.45; probSinVida = 0.20; }
      else if (edadNum > 60) { probConVida = 0.20; probDesaparecida = 0.35; probSinVida = 0.45; }
      else { probConVida = 0.30; probDesaparecida = 0.40; probSinVida = 0.30; }
      stats.porEdad[rango] = { total: 30, conVida: Math.round(30*probConVida), desaparecida: Math.round(30*probDesaparecida), sinVida: Math.round(30*probSinVida), probConVida, probDesaparecida, probSinVida };
    });

    for (let i = 0; i <= 10; i++) {
      const factor = i / 10;
      const probConVida = Math.max(0.2, 0.4 - factor * 0.2);
      const probDesaparecida = 0.4;
      const probSinVida = Math.min(0.4, 0.2 + factor * 0.2);
      stats.porMeses[i] = { total: 25, conVida: Math.round(25*probConVida), desaparecida: Math.round(25*probDesaparecida), sinVida: Math.round(25*probSinVida), probConVida, probDesaparecida, probSinVida };
    }

    this.estadisticas = stats;
    this.isTrained = true;
    return stats;
  }

  calcularProbabilidades(stats) {
    const total = stats.general.total;
    if (total > 0) {
      stats.general.probConVida = stats.general.conVida / total;
      stats.general.probDesaparecida = stats.general.desaparecida / total;
      stats.general.probSinVida = stats.general.sinVida / total;
    }

    const calcularProb = (obj) => {
      const laplaceAlpha = 1, k = 3;
      if (obj.total > 0) {
        obj.probConVida = (obj.conVida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
        obj.probDesaparecida = (obj.desaparecida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
        obj.probSinVida = (obj.sinVida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
      } else {
        obj.probConVida = stats.general.probConVida;
        obj.probDesaparecida = stats.general.probDesaparecida;
        obj.probSinVida = stats.general.probSinVida;
      }
    };

    Object.keys(stats.porMunicipio).forEach(m => calcularProb(stats.porMunicipio[m]));
    Object.keys(stats.porSexo).forEach(s => calcularProb(stats.porSexo[s]));
    Object.keys(stats.porEdad).forEach(e => calcularProb(stats.porEdad[e]));
    Object.keys(stats.porSexoEdad).forEach(se => calcularProb(stats.porSexoEdad[se]));
    Object.keys(stats.porMeses).forEach(m => calcularProb(stats.porMeses[m]));
  }

  predecir(sexo, edad, meses, municipio) {
    if (!this.isTrained || !this.estadisticas) return this.predecirBase(sexo, edad, meses, municipio);

    sexo = this.normalizarTexto(sexo);
    municipio = this.normalizarTexto(municipio);
    const rangoEdad = this.convertirEdadARango(edad);
    const claveSexoEdad = `${sexo}_${rangoEdad}`;
    const grupoMeses = Math.min(10, Math.floor(meses / 6));
    const probGeneral = this.estadisticas.general;
    const probMunicipio = this.estadisticas.porMunicipio[municipio];
    const probSexo = this.estadisticas.porSexo[sexo];
    const probEdad = this.estadisticas.porEdad[rangoEdad];
    const probSexoEdad = this.estadisticas.porSexoEdad[claveSexoEdad];
    const probMeses = this.estadisticas.porMeses[grupoMeses];

    let pConVida = 0, pDesaparecida = 0, pSinVida = 0, totalPeso = 0;

    const agregar = (prob, peso) => {
      if (prob && prob.total > 0) {
        const confianza = Math.min(1, prob.total / 100);
        const pesoAjustado = peso * (0.3 + 0.7 * confianza);
        pConVida += prob.probConVida * pesoAjustado;
        pDesaparecida += prob.probDesaparecida * pesoAjustado;
        pSinVida += prob.probSinVida * pesoAjustado;
        totalPeso += pesoAjustado;
      }
    };

    agregar(probMunicipio, 0.30);
    agregar(probSexoEdad, 0.25);
    agregar(probMeses, 0.20);
    agregar(probEdad, 0.15);
    agregar(probSexo, 0.10);

    if (totalPeso === 0) {
      pConVida = probGeneral.probConVida;
      pDesaparecida = probGeneral.probDesaparecida;
      pSinVida = probGeneral.probSinVida;
    } else {
      pConVida /= totalPeso;
      pDesaparecida /= totalPeso;
      pSinVida /= totalPeso;
    }

    const factorMeses = Math.min(1, meses / 60);
    pConVida *= (1 - factorMeses * 0.5);
    pSinVida *= (1 + factorMeses * 0.3);
    pDesaparecida = 1 - pConVida - pSinVida;

    [pConVida, pDesaparecida, pSinVida] = [Math.max(0.05, pConVida), Math.max(0.05, pDesaparecida), Math.max(0.05, pSinVida)];
    const total = pConVida + pDesaparecida + pSinVida;
    pConVida /= total; pDesaparecida /= total; pSinVida /= total;

    const conVida = Math.round(pConVida * 100);
    const desaparecida = Math.round(pDesaparecida * 100);
    const sinVida = Math.round(pSinVida * 100);
    const ajustado = this.ajustarSuma100(conVida, desaparecida, sinVida);

    let clase = "DESAPARECIDA";
    if (ajustado.conVida > ajustado.desaparecida && ajustado.conVida > ajustado.sinVida) clase = "CON VIDA";
    else if (ajustado.sinVida > ajustado.desaparecida && ajustado.sinVida > ajustado.conVida) clase = "SIN VIDA";

    return {
      conVida: ajustado.conVida,
      desaparecida: ajustado.desaparecida,
      sinVida: ajustado.sinVida,
      clase,
      confianza: this.calcularConfianza(probMunicipio, probSexoEdad, probMeses)
    };
  }

  predecirBase(sexo, edad, meses, municipio) {
    let baseConVida = 25, baseDesaparecida = 50, baseSinVida = 25;
    if (sexo === "MUJER") { baseConVida += 5; baseDesaparecida -= 3; }
    else { baseConVida -= 3; baseSinVida += 3; }
    if (edad < 18) { baseConVida += 15; baseSinVida -= 10; }
    else if (edad > 60) { baseConVida -= 8; baseSinVida += 8; }
    if (meses < 3) { baseConVida += 10; baseDesaparecida += 5; baseSinVida -= 15; }
    else if (meses > 24) { baseConVida -= 15; baseDesaparecida -= 10; baseSinVida += 25; }

    baseConVida = Math.max(5, baseConVida);
    baseDesaparecida = Math.max(10, baseDesaparecida);
    baseSinVida = Math.max(5, baseSinVida);

    const total = baseConVida + baseDesaparecida + baseSinVida;
    let conVida = Math.round((baseConVida / total) * 100);
    let desaparecida = Math.round((baseDesaparecida / total) * 100);
    let sinVida = 100 - conVida - desaparecida;
    const ajustado = this.ajustarSuma100(conVida, desaparecida, sinVida);

    let clase = "DESAPARECIDA";
    if (ajustado.conVida > ajustado.desaparecida && ajustado.conVida > ajustado.sinVida) clase = "CON VIDA";
    else if (ajustado.sinVida > ajustado.desaparecida && ajustado.sinVida > ajustado.conVida) clase = "SIN VIDA";

    return { ...ajustado, clase, confianza: 60 };
  }

  convertirEdadARango(edad) {
    if (edad <= 4) return "0-4";
    if (edad <= 9) return "5-9";
    if (edad <= 14) return "10-14";
    if (edad <= 19) return "15-19";
    if (edad <= 24) return "20-24";
    if (edad <= 29) return "25-29";
    if (edad <= 34) return "30-34";
    if (edad <= 39) return "35-39";
    if (edad <= 44) return "40-44";
    if (edad <= 49) return "45-49";
    if (edad <= 54) return "50-54";
    if (edad <= 59) return "55-59";
    if (edad <= 64) return "60-64";
    if (edad <= 69) return "65-69";
    return "70-74";
  }

  ajustarSuma100(a, b, c) {
    const total = a + b + c;
    if (total === 100) return { conVida: a, desaparecida: b, sinVida: c };
    const diff = 100 - total;
    if (a >= b && a >= c) return { conVida: a + diff, desaparecida: b, sinVida: c };
    if (b >= a && b >= c) return { conVida: a, desaparecida: b + diff, sinVida: c };
    return { conVida: a, desaparecida: b, sinVida: c + diff };
  }

  calcularConfianza(probMunicipio, probSexoEdad, probMeses) {
    let confianza = 50;
    if (probMunicipio && probMunicipio.total > 0) confianza += Math.min(25, Math.log10(probMunicipio.total + 1) * 10);
    if (probSexoEdad && probSexoEdad.total > 0) confianza += Math.min(15, Math.log10(probSexoEdad.total + 1) * 5);
    if (probMeses && probMeses.total > 0) confianza += Math.min(10, Math.log10(probMeses.total + 1) * 3);
    return Math.min(95, Math.max(40, confianza));
  }
}

function abrirNota() { document.getElementById('modalNota').style.display = 'block'; }
function cerrarNota() { document.getElementById('modalNota').style.display = 'none'; }
function abrirPrediccion() { document.getElementById("modalPrediccion").style.display = "block"; }
function cerrarPrediccion() { document.getElementById("modalPrediccion").style.display = "none"; }

function toggleSection(sec) {
  const content = document.getElementById(`section-${sec}`);
  const button = document.querySelector(`.section-toggle[onclick="toggleSection('${sec}')"]`);
  content.classList.toggle('collapsed');
  button.classList.toggle('active');
}

function toggleResumen() {
  const resumen = document.getElementById('resumenSeleccion');
  const header = document.querySelector('.resumen-header');
  resumen.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
}

function descargarGrafica() {
  if (!chartAnalisis) { alert("No hay gr√°fica para descargar."); return; }
  try {
    const a = document.createElement("a");
    a.href = chartAnalisis.toBase64Image();
    a.download = `grafica_desapariciones_${new Date().getTime()}.png`;
    a.click();
  } catch (error) {
    console.error("Error descargando gr√°fica:", error);
    alert("Error al descargar la gr√°fica.");
  }
}

function mostrarResultadosPrediccion(prediccion) {
  document.getElementById('probConVida').textContent = `${prediccion.conVida}%`;
  document.getElementById('probDesaparecida').textContent = `${prediccion.desaparecida}%`;
  document.getElementById('probSinVida').textContent = `${prediccion.sinVida}%`;

  setTimeout(() => {
    document.getElementById('barConVida').style.width = `${prediccion.conVida}%`;
    document.getElementById('barDesaparecida').style.width = `${prediccion.desaparecida}%`;
    document.getElementById('barSinVida').style.width = `${prediccion.sinVida}%`;
  }, 500);

  document.getElementById('predictionResults').style.display = 'block';
  document.getElementById('modelInfo').innerHTML = `
    Resultado m√°s probable: <strong>${prediccion.clase}</strong><br>
    <em>Confianza estimada: ${prediccion.confianza}%</em>
  `;
}

window.addEventListener('DOMContentLoaded', () => {
  fetch("stats_municipios_simple.json")
    .then(r => r.json())
    .then(json => {
      datos = json;
      poblarSelectoresGraficas();
      console.log("‚úÖ Datos para gr√°ficas cargados:", datos.length);
    })
    .catch(error => {
      console.error("Error cargando datos para gr√°ficas:", error);
      alert("Error al cargar los datos para gr√°ficas.");
    });

  fetch("stats_ml_training.json")
    .then(r => r.json())
    .then(json => {
      datosEntrenamiento = json;
      const statusEl = document.getElementById('modelStatus');
      statusEl.textContent = "‚è≥ Analizando datos de entrenamiento...";
      statusEl.className = "model-status training";

      try {
        predictor = new SimplePredictor();
        const stats = predictor.prepararEstadisticas(datosEntrenamiento);
        statusEl.textContent = `‚úÖ Modelo listo! (${stats.general.total.toLocaleString()} casos analizados)`;
        statusEl.className = "model-status ready";

        const modelInfo = document.getElementById('modelInfo');
        if (modelInfo) {
          modelInfo.innerHTML = `
            Modelo basado en ${stats.general.total.toLocaleString()} casos hist√≥ricos<br>
            ${Object.keys(stats.porMunicipio).length} municipios analizados
          `;
        }

        document.getElementById('btnPrediccion').disabled = false;
        document.getElementById('btnPrediccion').textContent = "Calcular Probabilidad";
      } catch (error) {
        console.error("Error entrenando modelo:", error);
        statusEl.textContent = "‚ö†Ô∏è Usando datos b√°sicos";
        statusEl.className = "model-status error";
        document.getElementById('btnPrediccion').disabled = false;
        document.getElementById('btnPrediccion').textContent = "Calcular (datos b√°sicos)";
      }
    })
    .catch(error => {
      console.error("Error cargando datos de entrenamiento:", error);
      const statusEl = document.getElementById('modelStatus');
      statusEl.textContent = "‚ö†Ô∏è Usando datos b√°sicos";
      statusEl.className = "model-status error";
      document.getElementById('btnPrediccion').disabled = false;
      document.getElementById('btnPrediccion').textContent = "Calcular (datos b√°sicos)";
    });

  document.getElementById('predMeses').addEventListener('input', function() {
    document.getElementById('mesesValue').textContent = `${this.value} meses`;
  });

  document.querySelectorAll("#chartTypes button").forEach(btn => {
    btn.addEventListener('click', () => {
      chartType = btn.dataset.type;
      document.querySelectorAll("#chartTypes button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  const firstBtn = document.querySelector('#chartTypes button');
  if (firstBtn) {
    firstBtn.classList.add('active');
    chartType = firstBtn.dataset.type;
  }

  document.querySelectorAll(".btn-generar").forEach(btn => {
    btn.addEventListener("click", generarGrafica);
  });

  document.getElementById('btnPrediccion').addEventListener('click', function() {
    if (this.disabled) { alert("El modelo a√∫n no est√° listo."); return; }

    const sexo = document.querySelector('input[name="predSexo"]:checked').value;
    const edad = parseInt(document.getElementById('predEdad').value);
    const meses = parseInt(document.getElementById('predMeses').value);
    const municipio = document.getElementById('predMunicipio').value;

    if (!municipio) { alert("Selecciona un municipio."); return; }

    const btn = this;
    const originalText = btn.textContent;
    btn.textContent = "Calculando...";
    btn.disabled = true;

    setTimeout(() => {
      try {
        const prediccion = predictor.predecir(sexo, edad, meses, municipio);
        mostrarResultadosPrediccion(prediccion);
      } catch (error) {
        console.error("Error en predicci√≥n:", error);
        alert("Error al calcular la predicci√≥n");
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }, 300);
  });
});

window.addEventListener('click', function(e) {
  if (e.target === document.getElementById('modalNota')) cerrarNota();
  if (e.target === document.getElementById('modalPrediccion')) cerrarPrediccion();
});



function actualizarResumenSeleccion() {
  try {
    // Obtener valores seleccionados de los selects originales
    const municipios = obtenerValoresSeleccionados('municipiosComparacion');
    const anios = obtenerValoresSeleccionados('aniosComparacion');
    const sexos = obtenerValoresSeleccionados('sexoComparacion');
    const rangosEdad = obtenerValoresSeleccionados('edadComparacion');
    const estados = obtenerValoresSeleccionados('estadoComparacion');
    const condiciones = obtenerValoresSeleccionados('condicionComparacion');

    // Si no hay municipios o a√±os, ocultar el resumen
    const resumenDiv = document.getElementById('resumenSeleccion');
    if (municipios.length === 0 || anios.length === 0) {
      return;
    }

    // Actualizar fecha/hora
    const ahora = new Date();
    document.getElementById('fechaHora').textContent = 
      ahora.toLocaleDateString() + ' ' + ahora.toLocaleTimeString();

    // Actualizar municipios
    const municipiosSpan = document.getElementById('municipiosResumen');
    if (municipios.length <= 3) {
      municipiosSpan.textContent = municipios.join(' ¬∑ ');
    } else {
      municipiosSpan.textContent = `${municipios.length} municipios: ${municipios.slice(0, 3).join(', ')} y ${municipios.length - 3} m√°s`;
    }

    // Actualizar a√±os
    const aniosSpan = document.getElementById('aniosResumen');
    aniosSpan.textContent = anios.sort().join(' ¬∑ ');

    // Filtros adicionales
    const filtrosSpan = document.getElementById('filtrosAdicionales');
    let filtrosTexto = [];
    if (sexos.length > 0 && sexos.length < 2) filtrosTexto.push(`Sexo: ${sexos.join('/')}`);
    else if (sexos.length === 2) filtrosTexto.push('Sexo: Ambos');
    
    if (rangosEdad.length > 0) filtrosTexto.push(`Edad: ${rangosEdad.length} rango(s)`);
    if (estados.length > 0) filtrosTexto.push(`Estado: ${estados.length} estado(s)`);
    if (condiciones.length > 0 && condiciones.length < 3) filtrosTexto.push(`Condici√≥n: ${condiciones.join('/')}`);
    else if (condiciones.length === 3) filtrosTexto.push('Condici√≥n: Todas');
    
    filtrosSpan.textContent = filtrosTexto.length > 0 ? 'üîç ' + filtrosTexto.join(' | ') : 'üîç Sin filtros adicionales';

    // FILTRO BASE para los datos
    const filtroBase = d =>
      municipios.includes(d.municipio) &&
      anios.includes(String(d.a√±o)) &&
      (sexos.length === 0 || sexos.includes(d.sexo)) &&
      (rangosEdad.length === 0 || rangosEdad.includes(d.rango_edad)) &&
      (estados.length === 0 || estados.includes(d.estatus_persona));

    // Calcular datos por municipio
    const datosMunicipio = {};
    
    municipios.forEach(mun => {
      const datosMun = datos.filter(d => d.municipio === mun && filtroBase(d));
      
      let conVida = 0, sinVida = 0, desaparecidos = 0;
      
      datosMun.forEach(d => {
        const total = Number(d.total) || 0;
        const cond = d.condicion_localizacion;
        
        if (cond === "CON VIDA" || cond === "Con vida") {
          conVida += total;
        } else if (cond === "SIN VIDA" || cond === "Sin vida") {
          sinVida += total;
        } else if (cond === "Desaparecida" || cond === "DESAPARECIDA") {
          desaparecidos += total;
        }
      });
      
      const total = conVida + sinVida + desaparecidos;
      
      datosMunicipio[mun] = { conVida, sinVida, desaparecidos, total };
    });

    // Generar filas de la tabla
    let tbodyHtml = '';
    let totalConVida = 0, totalSinVida = 0, totalDesaparecidos = 0, totalGeneral = 0;
    
    municipios.forEach(mun => {
      const d = datosMunicipio[mun] || { conVida: 0, sinVida: 0, desaparecidos: 0, total: 0 };
      
      totalConVida += d.conVida;
      totalSinVida += d.sinVida;
      totalDesaparecidos += d.desaparecidos;
      totalGeneral += d.total;
      
      // Calcular porcentajes
      const pctConVida = d.total > 0 ? (d.conVida / d.total * 100).toFixed(1) : 0;
      const pctSinVida = d.total > 0 ? (d.sinVida / d.total * 100).toFixed(1) : 0;
      const pctDesaparecidos = d.total > 0 ? (d.desaparecidos / d.total * 100).toFixed(1) : 0;
      
      tbodyHtml += `
        <tr>
          <td style="padding: 6px 8px; font-weight: bold;">${mun}</td>
          <td>
            ${d.conVida.toLocaleString()}
            <span style="font-size: 10px; color: #7f8c8d; display: block;">${pctConVida}%</span>
          </td>
          <td>
            ${d.sinVida.toLocaleString()}
            <span style="font-size: 10px; color: #7f8c8d; display: block;">${pctSinVida}%</span>
          </td>
          <td>
            ${d.desaparecidos.toLocaleString()}
            <span style="font-size: 10px; color: #7f8c8d; display: block;">${pctDesaparecidos}%</span>
          </td>
          <td>${d.total.toLocaleString()}</td>
        </tr>
      `;
    });

    document.getElementById('tablaResumenBody').innerHTML = tbodyHtml;

    // Totales generales
    const pctTotalConVida = totalGeneral > 0 ? (totalConVida / totalGeneral * 100).toFixed(1) : 0;
    const pctTotalSinVida = totalGeneral > 0 ? (totalSinVida / totalGeneral * 100).toFixed(1) : 0;
    const pctTotalDesaparecidos = totalGeneral > 0 ? (totalDesaparecidos / totalGeneral * 100).toFixed(1) : 0;

    document.getElementById('tablaResumenFoot').innerHTML = `
      <tr>
        <td>TOTAL</td>
        <td>
          ${totalConVida.toLocaleString()}
          <span style="font-size: 10px; color: #bdc3c7; display: block;">${pctTotalConVida}%</span>
        </td>
        <td>
          ${totalSinVida.toLocaleString()}
          <span style="font-size: 10px; color: #bdc3c7; display: block;">${pctTotalSinVida}%</span>
        </td>
        <td>
          ${totalDesaparecidos.toLocaleString()}
          <span style="font-size: 10px; color: #bdc3c7; display: block;">${pctTotalDesaparecidos}%</span>
        </td>
        <td>${totalGeneral.toLocaleString()}</td>
      </tr>
    `;

  } catch (error) {
    console.error("Error actualizando resumen:", error);
  }
}

// Agregar eventos a los selects para actualizar el resumen
document.addEventListener('DOMContentLoaded', function() {
  // Observar cambios en los selects principales
  const selectsActualizar = [
    'municipiosComparacion', 'aniosComparacion', 'sexoComparacion',
    'edadComparacion', 'estadoComparacion', 'condicionComparacion'
  ];
  
  selectsActualizar.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.addEventListener('change', function() {
        // Solo actualizar si hay municipios y a√±os seleccionados
        const municipios = obtenerValoresSeleccionados('municipiosComparacion');
        const anios = obtenerValoresSeleccionados('aniosComparacion');
        if (municipios.length > 0 && anios.length > 0) {
          actualizarResumenSeleccion();
        }
      });
    }
  });
});
</script>

</body>
</html>




