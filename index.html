




<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>An√°lisis y Probabilidad de Desapariciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* ===== 1 FEBRERO 2026 ===== */
:root {
  --primary-color: #2c3e50;
  --secondary-color: #3498db;
  --accent-color: #e74c3c;
  --prediction-color: #9b59b6;
  --success-color: #27ae60;
  --light-bg: #f8f9fa;
  --card-bg: #ffffff;
  --border-color: #e0e0e0;
  --text-color: #333333;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  --border-radius: 8px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #f6f5ef;
  font-family: 'Segoe UI', Arial, sans-serif;
  color: var(--text-color);
  height: 100vh;
  overflow: hidden;
}

/* ===== HEADER ===== */
header#top-header {
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary-color);
  color: white;
  font-size: 16px;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  position: relative;
  padding: 0 20px;
}

/* T√≠tulo centrado */
#top-header .title {
  margin: 0 auto;
  font-weight: 600;
  text-align: center;
}

/* Bot√≥n a la derecha */
#top-header button {
  position: absolute;
  right: 14px;
  padding: 6px 12px;
  border: 1px solid #000;
  background: #f6f5ef;
  cursor: pointer;
  border-radius: 6px;
  font-size: 12px;
}

/* ===== LAYOUT ===== */
#layout {
  display: flex;
  height: calc(100vh - 50px);
  padding: 10px;
  gap: 10px;
  overflow: hidden;
}

/* ===== PANEL IZQUIERDO ===== */
#panel {
  width: 280px;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 15px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  max-height: 100%;
  transition: left 0.3s ease;
}

#panel::-webkit-scrollbar {
  width: 4px;
}

#panel::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 2px;
}

label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text-color);
}

select, input {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: white;
  font-size: 12px;
  color: var(--text-color);
}

select:focus, input:focus {
  outline: none;
  border-color: var(--secondary-color);
}

/* ===== SECCI√ìN DE PREDICCI√ìN ===== */
.prediction-section {
  background: rgba(155, 89, 182, 0.05);
  padding: 12px;
  border-radius: var(--border-radius);
  margin: 8px 0;
  border-left: 3px solid var(--prediction-color);
}

.prediction-section h4 {
  color: var(--prediction-color);
  margin-bottom: 10px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* ===== BOTONES ===== */
.radio-group {
  display: flex;
  gap: 10px;
  margin: 6px 0;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
}

.radio-option input[type="radio"] {
  width: 14px;
  height: 14px;
  accent-color: var(--prediction-color);
}

.range-container {
  margin: 8px 0;
}

.range-value {
  text-align: center;
  font-size: 11px;
  color: var(--prediction-color);
  margin-top: 4px;
  font-weight: 600;
}

/* ===== CHECKBOX ===== */
.checkbox-container {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 6px 0;
  cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
  width: 14px;
  height: 14px;
  accent-color: var(--secondary-color);
}

/* ===== TIPOS DE GR√ÅFICA ===== */
#chartTypes {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-top: 4px;
}

#chartTypes button {
  padding: 6px 4px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background: white;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

#chartTypes button:hover {
  border-color: var(--secondary-color);
  transform: translateY(-1px);
}

#chartTypes button.active {
  background: var(--secondary-color);
  color: white;
  border-color: var(--secondary-color);
}

/* ===== BOTONES ===== */
#btnGenerar {
  margin-top: 8px;
  padding: 10px;
  border-radius: 6px;
  border: none;
  background: var(--success-color);
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

#btnGenerar:hover {
  background: #219653;
  transform: translateY(-1px);
}

#btnPrediccion {
  background: var(--prediction-color);
  color: white;
  border: none;
  padding: 10px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 6px;
}

#btnPrediccion:hover {
  background: #8e44ad;
  transform: translateY(-1px);
}

/* ===== RESULTADOS DE PREDICCI√ìN ===== */
.prediction-results {
  display: none;
  background: white;
  border-radius: var(--border-radius);
  padding: 12px;
  margin-top: 10px;
  border: 2px solid var(--prediction-color);
  box-shadow: var(--shadow);
}

.prediction-results h5 {
  color: var(--prediction-color);
  margin-bottom: 8px;
  font-size: 12px;
}

.result-item {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
  font-size: 11px;
}

.result-bar {
  height: 10px;
  background: #ecf0f1;
  border-radius: 5px;
  margin-top: 2px;
  overflow: hidden;
}

.result-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 1s ease-out;
}

.result-fill.con-vida { background: #2ecc71; }
.result-fill.desaparecida { background: #f39c12; }
.result-fill.sin-vida { background: #e74c3c; }

/* ===== COMPARAR===== */
.compare-box {
  background: var(--light-bg);
  padding: 10px;
  border-radius: 6px;
  margin: 4px 0;
  border-left: 3px solid var(--accent-color);
}

/* ===== CR√âDITOS ===== */
#creditos {
  text-align: center;
  margin-top: 10px;
  padding-top: 10px;
  font-size: 11px;
  color: #666;
  border-top: 1px solid var(--border-color);
}

#creditos a {
  color: var(--secondary-color);
  text-decoration: none;
  font-weight: 600;
}

/* ===== √ÅREA DE GR√ÅFICA ===== */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 0;
}

/* ===== RESUMEN ===== */
#resumen {
  background: var(--card-bg);
  padding: 10px;
  border-radius: var(--border-radius);
  font-weight: 600;
  text-align: center;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  font-size: 12px;
  color: var(--primary-color);
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== CANVAS ===== */
.chart-container {
  flex: 1;
  background: var(--card-bg);
  border-radius: var(--border-radius);
  padding: 15px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border-color);
  min-height: 0;
  position: relative;
}

canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

/* ===== BOT√ìN DESCARGAR ===== */
#main > button:last-child {
  align-self: flex-start;
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  background: var(--primary-color);
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

#main > button:last-child:hover {
  background: #34495e;
  transform: translateY(-1px);
}

/* Fondo oscuro */
.nota-oculta {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  z-index: 9999;
}

/* Caja */
#modalPrediccion .nota-contenido {
  background: #ffffff;
  max-width: 520px;
  max-height: 80vh;
  margin: 8vh auto;
  padding: 20px;
  border-radius: 10px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.5;
}

.nota-contenido h3 {
  margin-top: 0;
  text-align: center;
}

.nota-aviso {
  font-weight: bold;
  margin-top: 15px;
}

.nota-contenido button {
  margin-top: 15px;
  width: 100%;
  padding: 10px;
  background: #111;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* ===== ANIMACIONES ===== */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#panel, #main {
  animation: fadeIn 0.5s ease-out;
}

/* ===== SCROLLBAR===== */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--light-bg);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: var(--secondary-color);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-color);
}

/* ===== ESTILOS SELECCI√ìN MULTIPLE ===== */
#aniosSeleccionados {
  border-radius: 8px;
  padding: 10px;
  background: var(--light-bg);
  border: 2px solid var(--border-color);
  height: 100px;
  display: none;
}

#aniosSeleccionados:focus {
  border-color: var(--secondary-color);
  outline: none;
}

#aniosSeleccionados option {
  padding: 8px;
  margin: 2px 0;
  border-radius: 4px;
  cursor: pointer;
}

#aniosSeleccionados option:hover {
  background: var(--secondary-color);
  color: white;
}

/* ===== MODALES ===== */
#modalNota{
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 9999;
}

#modalContenido{
  background: #fff;
  max-width: 520px;
  margin: 10% auto;
  padding: 20px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.5;
  max-height: 70vh;
  overflow-y: auto;
}

#modalContenido h3{
  margin-top: 0;
  border-bottom: 2px solid #000;
  padding-bottom: 10px;
}

/* ===== ESTADO DEL MODELO ===== */
.model-status {
  font-size: 10px;
  text-align: center;
  padding: 5px;
  margin: 5px 0;
  border-radius: 4px;
}

.model-status.training {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.model-status.ready {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.model-status.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* ===== BOTONES PLEGABLES ===== */
.section-toggle {
  width: 100%;
  padding: 14px 16px;
  border-radius: 10px;
  border: 2px solid transparent;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  margin-bottom: 8px;

  display: flex;
  align-items: center;
  justify-content: space-between;

  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow:
    0 2px 8px rgba(0, 0, 0, 0.05),
    0 1px 2px rgba(0, 0, 0, 0.05),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);

  color: #2c3e50;
  font-size: 14px;
}

.section-toggle:hover {
  transform: translateY(-1px);
  box-shadow:
    0 4px 12px rgba(0, 0, 0, 0.08),
    0 2px 4px rgba(0, 0, 0, 0.06),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-color: #e0e0e0;
}

.section-toggle:active {
  transform: translateY(0);
  transition-duration: 0.1s;
}

.section-toggle::after {
  content: "‚ñº";
  font-size: 12px;
  opacity: 0.7;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: rotate(0deg);
  font-weight: bold;
  margin-left: 8px;
}

.section-toggle.active {
  background: linear-gradient(145deg, var(--primary-color), #1a2530);
  color: white;
  border-color: var(--primary-color);
  box-shadow:
    0 4px 16px rgba(44, 62, 80, 0.15),
    0 2px 8px rgba(44, 62, 80, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.section-toggle.active:hover {
  background: linear-gradient(145deg, #1a2530, var(--primary-color));
  box-shadow:
    0 6px 20px rgba(44, 62, 80, 0.2),
    0 3px 8px rgba(44, 62, 80, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.section-toggle.active::after {
  transform: rotate(180deg);
  opacity: 1;
  color: rgba(255, 255, 255, 0.9);
}

.section-content {
  margin: 8px 0 16px 0;
  padding: 0 4px;
  animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 1;
  transform-origin: top;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.section-content.collapsed {
  display: none;
}

.section-toggle.with-icon {
  padding-left: 44px;
  position: relative;
}

.section-toggle.with-icon::before {
  content: "üìä";
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  opacity: 0.8;
}

.section-toggle.with-icon.active::before {
  content: "üìä";
  opacity: 1;
}

.section-toggle[onclick*="prediccion"]::before {
  content: "‚ÑÖ";
}

.section-toggle::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 8px;
  padding: 2px;
  background: linear-gradient(135deg,
    rgba(52, 152, 219, 0) 0%,
    rgba(52, 152, 219, 0.1) 50%,
    rgba(52, 152, 219, 0) 100%);
  -webkit-mask:
    linear-gradient(#fff 0 0) content-box,
    linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.section-toggle:hover::before {
  opacity: 1;
}

.section-toggle.active::before {
  background: linear-gradient(135deg,
    rgba(255, 255, 255, 0.2) 0%,
    rgba(255, 255, 255, 0.4) 50%,
    rgba(255, 255, 255, 0.2) 100%);
  opacity: 1;
}

.section-toggle.minimal {
  background: transparent;
  border: 1px solid #e0e0e0;
  box-shadow: none;
}

.section-toggle.minimal:hover {
  background: rgba(0, 0, 0, 0.02);
  border-color: #3498db;
}

.section-toggle.minimal.active {
  background: rgba(44, 62, 80, 0.05);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

/* ===== MOBILE ===== */
#mobileToggle {
  display: none;
}

@media (max-width: 768px) {
  #panel {
    position: fixed;
    top: 0;
    left: -100%;
    width: 85%;
    height: 100%;
    z-index: 9999;
    transition: 0.3s;
  }

  #panel.open {
    left: 0;
  }

  #mobileToggle {
    display: flex;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #2c3e50;
    color: #fff;
    font-size: 24px;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 10000;
  }

  #layout {
    flex-direction: column;
  }

  #panel {
    width: 100%;
    position: relative;
    left: 0;
  }
}
/* ===== ESTILOS PARA SELECCI√ìN M√öLTIPLE ===== */
#municipiosComparacion {
  width: 100%;
  min-height: 120px;
  max-height: 180px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  background-color: white;
  font-size: 12px;
  overflow-y: auto;
}

#municipiosComparacion option {
  padding: 6px 8px;
  margin: 2px 0;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

#municipiosComparacion option:hover {
  background-color: var(--secondary-color);
  color: white;
}

#municipiosComparacion option:checked {
  background-color: var(--primary-color);
  color: white;
  font-weight: bold;
}

.contador-municipios {
  font-size: 11px;
  color: #666;
  margin-top: 5px;
  font-style: italic;
  text-align: center;
}
/* ===== BOT√ìN SECUNDARIO ===== */
/* ===== BOT√ìN SECUNDARIO MEJORADO ===== */
.btn-secundario {
  background-color: #6c757d;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 8px;
  font-size: 11px;
  width: 100%;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-secundario:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.btn-secendario:active {
  transform: translateY(0);
}
</style>

</head>
<body>

<header id="top-header">
  <span class="title">
    üìä Gr√°ficas y Probabilidad por Municipio
  </span>
  <button id="btnNota" onclick="abrirNota()">‚ÑπÔ∏è Nota metodol√≥gica</button>
</header>


<div id="layout">
  <!-- PANEL COMPACTO -->
  <div id="panel">
    <button class="section-toggle" onclick="toggleSection('graficas')">
      üìä Gr√°ficas
    </button>

<div id="section-graficas" class="section-content collapsed">
  <!-- SECCI√ìN DE AN√ÅLISIS -->
  <div>
    <label>Municipios a comparar:</label>
    <select id="municipiosComparacion" multiple size="5">
      <!-- Opciones se llenar√°n din√°micamente -->
    </select>
    <div class="ayuda" style="font-size: 11px; color: #666; margin-top: 3px;">
      (Ctrl+Click PC)(Command+Click MAC)para seleccionar m√∫ltiples
    </div>
    
    <button type="button" id="seleccionarTodos" class="btn-secundario" style="
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 11px;
      width: 100%;
    ">
      Seleccionar Todos
    </button>
    
    <div id="contadorMunicipios" class="contador-municipios" style="
      font-size: 11px;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    ">
      Seleccionados: 0 municipios
    </div>
  </div>

      <div>
        <label>A√±o</label>
        <select id="anio"></select>

        <label>Sexo</label>
        <select id="sexo"></select>

        <label>Rango de Edad</label>
        <select id="edad"></select>

        <label>¬øQu√© quieres analizar?</label>
        <select id="metrica">
          <option value="estatus_persona">Estado de la persona</option>
          <option value="condicion_localizacion">Condici√≥n de localizaci√≥n</option>
        </select>
      </div>

      <div>
        <label>Tipo de an√°lisis</label>
        <select id="modo">
          <option value="simple">Un a√±o</option>
          <option value="temporal">Evoluci√≥n en el tiempo</option>
        </select>

        <div class="checkbox-container">
          <input type="checkbox" id="filtrarAnios">
          <label for="filtrarAnios" style="margin: 0; font-size: 11px;">Seleccionar a√±os espec√≠ficos</label>
        </div>
        <select id="aniosSeleccionados" multiple style="display:none"></select>
      </div>

      <div>
        <label>Tipo de gr√°fica</label>
        <div id="chartTypes">
          <button data-type="bar">Barras</button>
          <button data-type="stackedBar">Barras Apiladas</button>
          <button data-type="area">√Årea</button>
          <button data-type="stackedArea">√Årea Apiladas</button>
          <button data-type="line">L√≠nea</button>
          <button data-type="pie">Pastel</button>
        </div>
      </div>

      <button id="btnGenerar">
        Generar gr√°fica
      </button>
    </div>

    <button class="section-toggle" onclick="toggleSection('prediccion')">
      Probabilidad
    </button>

    <div id="section-prediccion" class="section-content collapsed">
      <!-- SECCI√ìN DE PREDICCI√ìN -->
      <div class="prediction-section">
        <h4>Probabilidad de Resultado</h4>

        <div id="modelStatus" class="model-status training">
          ‚è≥ Cargando datos de entrenamiento...
        </div>

        <label>Sexo</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="predSexo" value="MUJER" checked>
            Mujer
          </label>
          <label class="radio-option">
            <input type="radio" name="predSexo" value="HOMBRE">
            Hombre
          </label>
        </div>

        <label>Edad</label>
        <select id="predEdad">
          <option value="2">0-4 a√±os</option>
          <option value="7">5-9 a√±os</option>
          <option value="12">10-14 a√±os</option>
          <option value="17">15-19 a√±os</option>
          <option value="22">20-24 a√±os</option>
          <option value="27">25-29 a√±os</option>
          <option value="32">30-34 a√±os</option>
          <option value="37">35-39 a√±os</option>
          <option value="42">40-44 a√±os</option>
          <option value="47">45-49 a√±os</option>
          <option value="52">50-54 a√±os</option>
          <option value="57">55-59 a√±os</option>
          <option value="62">60-64 a√±os</option>
          <option value="67">65-69 a√±os</option>
          <option value="72">70-74 a√±os</option>
        </select>

        <label>Meses entre desaparici√≥n y reporte</label>
        <div class="range-container">
          <input type="range" id="predMeses" min="0" max="60" value="12" class="range-slider">
          <div class="range-value" id="mesesValue">12 meses</div>
        </div>

        <label>Municipio</label>
        <select id="predMunicipio"></select>

        <button id="btnPrediccion" disabled>
          ‚è≥ Modelo no listo
        </button>

        <!-- RESULTADOS DE PREDICCI√ìN -->
        <div id="predictionResults" class="prediction-results">
          <h5>Probabilidades estimadas:</h5>

          <div class="result-item">
            <span>Con vida:</span>
            <span id="probConVida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barConVida" class="result-fill con-vida" style="width: 0%"></div>
          </div>

          <div class="result-item">
            <span>Desaparecida:</span>
            <span id="probDesaparecida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barDesaparecida" class="result-fill desaparecida" style="width: 0%"></div>
          </div>

          <div class="result-item">
            <span>Sin vida:</span>
            <span id="probSinVida">--%</span>
          </div>
          <div class="result-bar">
            <div id="barSinVida" class="result-fill sin-vida" style="width: 0%"></div>
          </div>

          <div style="margin-top: 10px; font-size: 10px; color: #666; text-align: center;" id="modelInfo">
            Modelo basado en datos hist√≥ricos
          </div>
        </div>
      </div>

      <button id="btnNotaPrediccion" onclick="abrirPrediccion()">‚ÑπÔ∏è Nota probabilidad</button>

          </div>
      <div id="creditos">
        Elabor√≥
        <a href="https://x.com/rys2000dev" target="_blank">rys2000dev</a>
        <br>
        Acad√©mico
        <a href="https://x.com/joraplas?lang=es" target="_blank">joraplas</a>
      </div>
  </div>

  <!-- GR√ÅFICA -->
  <div id="main">
    <div id="resumen">Selecciona los filtros y haz clic en "Generar gr√°fica"</div>

    <div class="chart-container">
      <canvas id="grafica"></canvas>
    </div>

    <button onclick="descargarGrafica()">
      ‚¨áÔ∏è Descargar gr√°fica
    </button>
  </div>
</div>

<div id="modalNota">
  <div id="modalContenido">
    <h3>Nota metodol√≥gica</h3>
    <p>La informaci√≥n presentada en esta p√°gina se basa en datos p√∫blicos obtenidos
      del Registro Estatal de Personas Desaparecidas del Estado de Jalisco, disponible
      en su versi√≥n p√∫blica en: <br>
      https://version-publica-repd.jalisco.gob.mx/
    </p>

    <p><strong>üìä Fuente de datos</strong></p>
    <p>El conjunto de datos original incluye 36,927 registros correspondientes a
      personas reportadas como desaparecidas en el estado de Jalisco,
      con fechas que abarcan desde el a√±o 1942 hasta diciembre de 2025.
    </p>

    <p><strong>üßπ Proceso de depuraci√≥n</strong></p>
    <p>Para el an√°lisis y visualizaci√≥n de la informaci√≥n se realiz√≥ un proceso de depuraci√≥n
      y normalizaci√≥n que incluy√≥, entre otros aspectos:<br><br>
      Homologaci√≥n de nombres de municipios y variables. Agrupaci√≥n temporal por a√±o.<br>
      Clasificaci√≥n por genero, rango de edad y estatus del caso cuando la informaci√≥n
      estaba disponible.<br>
      Los registros que no contaban con informaci√≥n m√≠nima necesaria para ciertos
      an√°lisis fueron excluidos del total hist√≥rico de casos; (928 casos).
    </p>

    <p><strong>üìà Alcance del an√°lisis</strong></p>
    <p>Las gr√°ficas presentadas tienen un car√°cter descriptivo y exploratorio,
      con el objetivo de:<br><br>
      Identificar patrones temporales y geogr√°ficos.<br>
      Facilitar la comprensi√≥n de la magnitud del fen√≥meno.<br>
      Apoyar la prevenci√≥n, el an√°lisis social y la difusi√≥n de informaci√≥n p√∫blica.<br>
      Este an√°lisis no pretende sustituir investigaciones oficiales, ni establecer responsabilidades,
      causas directas o conclusiones judiciales.<br><br>
      <strong>‚ö†Ô∏è Consideraciones importantes</strong><br>
      Los datos reflejan reportes administrativos, por lo que pueden existir rezagos,
      actualizaciones posteriores o reclasificaciones.<br>
      La ausencia de un registro no implica la inexistencia del caso.<br>
      Las cifras pueden diferir de otros informes oficiales debido a fechas de corte,
      criterios de clasificaci√≥n o actualizaciones del registro original.<br><br>
      <strong>ü§ù Uso responsable de la informaci√≥n</strong><br>
      Esta p√°gina y sus visualizaciones tienen fines informativos, preventivos y sociales.
      Se busca contribuir a la comprensi√≥n del problema de la desaparici√≥n de personas
      basada en datos p√∫blicos.
    </p>

    <button onclick="cerrarNota()">Cerrar</button>
  </div>
</div>

<!-- ========================= -->
<!-- NOTA PREDICCION -->
<!-- ========================= -->
<div id="modalPrediccion" class="nota-oculta">
  <div class="nota-contenido">
    <h3>Nota Metodol√≥gica - Modelo de Probabilidad</h3>

<p><strong>√öltima actualizaci√≥n:</strong> 21 de enero de 2026</p>

<h4>üß† Modelo Implementado</h4>
<p>
  Sistema de <strong>estimaci√≥n probabil√≠stica basada en estad√≠sticas hist√≥ricas</strong>
  (modelo Naive Bayes simplificado), dise√±ado para identificar
  <strong>patrones observados en registros anteriores</strong> y generar
  <strong>estimaciones orientativas de resultado</strong>.
</p>

<h4>‚öôÔ∏è Variables Analizadas</h4>
<ul>
  <li><strong>Municipio:</strong> patrones geogr√°ficos hist√≥ricos</li>
  <li><strong>Sexo:</strong> tendencias observadas por g√©nero (HOMBRE / MUJER)</li>
  <li><strong>Edad:</strong> 15 rangos etarios (0‚Äì4, 5‚Äì9, ‚Ä¶, 70‚Äì74)</li>
  <li><strong>Tiempo:</strong> meses transcurridos desde la desaparici√≥n (0‚Äì60)</li>
  <li><strong>Interacciones:</strong> combinaciones sexo‚Äìedad y municipio‚Äìtiempo,
      incorporadas para capturar dependencias hist√≥ricas relevantes</li>
</ul>

<h4>üìà Fuente de Datos</h4>
<p>
  Modelo construido a partir de <strong>35,998 registros hist√≥ricos</strong> del
  Registro Estatal de Personas Desaparecidas de Jalisco (REPD),
  correspondientes al periodo <strong>1942‚Äì2025</strong>.
</p>

<p>Distribuci√≥n observada en el conjunto hist√≥rico analizado:</p>
<ul>
  <li><span style="color:#2ecc71;">‚óè CON VIDA:</span> ~25‚Äì35%</li>
  <li><span style="color:#f39c12;">‚óè DESAPARECIDA:</span> ~40‚Äì50%</li>
  <li><span style="color:#e74c3c;">‚óè SIN VIDA:</span> ~25‚Äì35%</li>
</ul>

<p style="font-size:12px; color:#666;">
  *Estos porcentajes describen la composici√≥n del conjunto de datos hist√≥rico
  y no representan probabilidades reales aplicables a casos individuales.*
</p>

<h4>üîß Algoritmo</h4>
<p><strong>F√≥rmula base:</strong><br>
  <code>P(resultado | caracter√≠sticas) ‚àù P(caracter√≠sticas | resultado) √ó P(resultado)</code>
</p>

<p>
  La expresi√≥n indica una <strong>relaci√≥n proporcional</strong>; los valores obtenidos
  se <strong>normalizan</strong> para construir una distribuci√≥n comparativa entre
  escenarios posibles. El modelo asume independencia condicional aproximada,
  mitigada parcialmente mediante el uso de interacciones emp√≠ricas.
</p>

<p>
  Se aplican <strong>ponderaciones din√°micas</strong> y
  <strong>suavizado de Laplace</strong> para reducir sesgos derivados de
  escasez de datos en ciertos subgrupos.
  <br>
  <strong>Indicador de confianza:</strong> 40‚Äì95%, calculado de forma heur√≠stica
  seg√∫n la cantidad, estabilidad y consistencia de registros hist√≥ricos comparables.
</p>

<h4>‚ö†Ô∏è Limitaciones T√©cnicas</h4>

<p><strong>Lo que NO hace:</strong></p>
<ul>
  <li>‚ùå No utiliza modelos de aprendizaje autom√°tico avanzado (ej. redes neuronales)</li>
  <li>‚ùå No incorpora variables socioecon√≥micas ni contextuales</li>
  <li>‚ùå No analiza circunstancias espec√≠ficas de cada desaparici√≥n</li>
  <li>‚ùå No integra informaci√≥n sobre violencia regional o criminal</li>
</ul>

<p><strong>Lo que S√ç hace:</strong></p>
<ul>
  <li>‚úÖ Analiza patrones hist√≥ricos simples y documentados</li>
  <li>‚úÖ Produce estimaciones coherentes cuando existen datos suficientes</li>
  <li>‚úÖ Se√±ala expl√≠citamente escenarios de baja confiabilidad</li>
  <li>‚úÖ Prioriza transparencia, trazabilidad e interpretabilidad</li>
</ul>

<h4>üéØ Alcance y Consistencia</h4>
<p>
  ‚Ä¢ <strong>Consistencia hist√≥rica orientativa:</strong> ~65‚Äì75% en an√°lisis retrospectivo exploratorio<br>
  ‚Ä¢ <strong>Mejor desempe√±o:</strong> municipios con m√°s de 100 registros hist√≥ricos
</p>

<div style="background:#f8f9fa; padding:15px; border-radius:6px; margin-top:20px; border-left:4px solid #3498db;">
  <p><strong>üìù Responsabilidad √âtica</strong></p>
  <p style="margin-bottom:0;">
    Esta herramienta tiene fines informativos, preventivos y sociales.
    No sustituye investigaciones oficiales ni procesos judiciales.
    <br><br>
    <strong>Las estimaciones generadas deben interpretarse como orientaci√≥n estad√≠stica,
    y nunca como conclusiones definitivas sobre un caso individual.</strong>
  </p>
</div>


      <button onclick="cerrarPrediccion()">Cerrar</button>
    </div>
  </div>

<script>
// =========================
// VARIABLES GLOBALES
// =========================
let datos = [];  // Para gr√°ficas (stats_municipios_simple.json)
let datosEntrenamiento = [];  // Para modelo ML (stats_ml_training.json)
let chartAnalisis;
let chartType = "bar";
let modeloEntrenado = false;

// =========================
// PLUGINS DE CHART.JS
// =========================
const watermarkPlugin = {
  id: 'watermark',
  afterDraw(chart, args, options) {
    const { ctx, chartArea } = chart;
    if (!chartArea) return;

    const {
      text = 'rys2000dev',
      fontSize = 26,
      opacity = 0.07,
      color = '#000',
      angle = 0
    } = options;

    ctx.save();
    ctx.translate(
      chartArea.left + chartArea.width / 2,
      chartArea.top + chartArea.height / 2
    );
    ctx.rotate(angle * Math.PI / 180);
    ctx.globalAlpha = opacity;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `bold ${fontSize}px Helvetica, Arial, sans-serif`;
    ctx.fillText(text, 0, 0);
    ctx.restore();
  }
};

const whiteBackgroundPlugin = {
  id: 'whiteBackground',
  beforeDraw(chart) {
    const { ctx, width, height } = chart;
    ctx.save();
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, width, height);
    ctx.restore();
  }
};

Chart.register(ChartDataLabels, watermarkPlugin, whiteBackgroundPlugin);

const BASE_COLORS = [
  '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
  '#1abc9c', '#34495e', '#e67e22', '#16a085', '#8e44ad',
  '#27ae60', '#d35400', '#c0392b', '#2980b9', '#8e44ad'
];

function apply3DEffects(datasets, type, fillArea) {
  return datasets.map((ds, index) => {
    const newDataset = { ...ds };
    const colorIndex = index % BASE_COLORS.length;
    const baseColor = BASE_COLORS[colorIndex];

    const r = parseInt(baseColor.slice(1, 3), 16);
    const g = parseInt(baseColor.slice(3, 5), 16);
    const b = parseInt(baseColor.slice(5, 7), 16);

    switch(type) {
      case 'bar':
      case 'stackedBar':
        newDataset.barPercentage = 0.7;
        newDataset.categoryPercentage = 0.8;
        newDataset.borderRadius = {
          topLeft: 8,
          topRight: 8,
          bottomLeft: 3,
          bottomRight: 3
        };
        newDataset.borderSkipped = false;
        newDataset.borderWidth = 2;
        newDataset.borderColor = `rgba(${Math.max(0, r - 50)}, ${Math.max(0, g - 50)}, ${Math.max(0, b - 50)}, 1)`;
        newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
        break;

      case 'pie':
        newDataset.borderWidth = 3;
        newDataset.borderColor = '#ffffff';
        newDataset.borderAlign = 'inner';
        newDataset.hoverOffset = 15;
        newDataset.borderRadius = 5;
        newDataset.rotation = -30;
        newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
        break;

      case 'line':
      case 'area':
        newDataset.borderWidth = 3;
        newDataset.tension = 0.35;
        newDataset.fill = fillArea;
        newDataset.pointRadius = 10;
        newDataset.pointHoverRadius = 13;
        newDataset.pointBorderWidth = 2;
        newDataset.pointBackgroundColor = baseColor;
        newDataset.pointBorderColor = '#ffffff';
        newDataset.borderColor = baseColor;

        if (fillArea) {
          newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.25)`;
        }
        break;

      default:
        if (!newDataset.backgroundColor) {
          newDataset.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
        }
        if (!newDataset.borderColor) {
          newDataset.borderColor = baseColor;
        }
        break;
    }

    if (!newDataset.borderWidth) {
      newDataset.borderWidth = 2;
    }

    return newDataset;
  });
}

// =========================
// MODELO DE PREDICCI√ìN
// =========================

class SimplePredictor {
  constructor() {
    this.estadisticas = null;
    this.isTrained = false;
    this.debug = true; // Activar modo debug
  }

  // Preparar estad√≠sticas de los datos de entrenamiento
  prepararEstadisticas(datos) {
    console.log("=== DEBUG: Iniciando preparaci√≥n de estad√≠sticas ===");
    console.log("Total de registros recibidos:", datos.length);

    const stats = {
      porMunicipio: {},
      porSexo: {},
      porEdad: {},
      porMeses: {},
      porSexoEdad: {},
      general: {
        total: 0,
        conVida: 0,
        desaparecida: 0,
        sinVida: 0
      }
    };

    // Depuraci√≥n: ver estructura del primer registro
    if (datos.length > 0) {
      console.log("=== DEBUG: Primer registro ===");
      console.log("Keys:", Object.keys(datos[0]));
      console.log("Valores:", datos[0]);
    }

    const datosCompletos = datos.filter(d => {
      const tieneDatos =
        d.sexo &&
        d.rango_edad &&
        d.municipio &&
        d.estatus_persona &&
        d.condicion_localizacion &&
        d.meses !== null &&
        d.meses !== undefined;

      if (!tieneDatos && this.debug) {
        console.log("Registro incompleto:", {
          sexo: d.sexo,
          rango_edad: d.rango_edad,
          municipio: d.municipio,
          estatus_persona: d.estatus_persona,
          condicion_localizacion: d.condicion_localizacion,
          meses: d.meses
        });
      }

      return tieneDatos;
    });

    console.log("=== DEBUG: Datos completos encontrados:", datosCompletos.length);

    if (datosCompletos.length === 0) {
      console.warn("No hay datos completos para entrenamiento");
      console.log("=== DEBUG: Usando estad√≠sticas b√°sicas ===");
      return this.crearEstadisticasBasicas();
    }

    // Procesar cada registro
    datosCompletos.forEach((d, index) => {
      // Estad√≠sticas generales
      stats.general.total++;

      const condicion = this.normalizarTexto(d.condicion_localizacion);

      if (condicion === "CON VIDA") {
        stats.general.conVida++;
      } else if (condicion === "SIN VIDA") {
        stats.general.sinVida++;
      } else if (condicion === "DESAPARECIDA") {
        stats.general.desaparecida++;
      }

      // Normalizar datos
      const municipio = this.normalizarTexto(d.municipio);
      const sexo = this.normalizarTexto(d.sexo);
      const rangoEdad = d.rango_edad;
      const claveSexoEdad = `${sexo}_${rangoEdad}`;
      const meses = parseInt(d.meses) || 0;
      const grupoMeses = Math.min(10, Math.floor(meses / 6));

      // Estad√≠sticas por Municipio
      if (!stats.porMunicipio[municipio]) {
        stats.porMunicipio[municipio] = {
          total: 0,
          conVida: 0,
          desaparecida: 0,
          sinVida: 0
        };
      }
      stats.porMunicipio[municipio].total++;
      if (condicion === "CON VIDA") stats.porMunicipio[municipio].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porMunicipio[municipio].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porMunicipio[municipio].sinVida++;

      // Estad√≠sticas por Sexo
      if (!stats.porSexo[sexo]) {
        stats.porSexo[sexo] = {
          total: 0,
          conVida: 0,
          desaparecida: 0,
          sinVida: 0
        };
      }
      stats.porSexo[sexo].total++;
      if (condicion === "CON VIDA") stats.porSexo[sexo].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porSexo[sexo].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porSexo[sexo].sinVida++;

      // Estad√≠sticas por Edad
      if (!stats.porEdad[rangoEdad]) {
        stats.porEdad[rangoEdad] = {
          total: 0,
          conVida: 0,
          desaparecida: 0,
          sinVida: 0
        };
      }
      stats.porEdad[rangoEdad].total++;
      if (condicion === "CON VIDA") stats.porEdad[rangoEdad].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porEdad[rangoEdad].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porEdad[rangoEdad].sinVida++;

      // Estad√≠sticas por Sexo + Edad
      if (!stats.porSexoEdad[claveSexoEdad]) {
        stats.porSexoEdad[claveSexoEdad] = {
          total: 0,
          conVida: 0,
          desaparecida: 0,
          sinVida: 0
        };
      }
      stats.porSexoEdad[claveSexoEdad].total++;
      if (condicion === "CON VIDA") stats.porSexoEdad[claveSexoEdad].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porSexoEdad[claveSexoEdad].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porSexoEdad[claveSexoEdad].sinVida++;

      // Estad√≠sticas por Meses
      if (!stats.porMeses[grupoMeses]) {
        stats.porMeses[grupoMeses] = {
          total: 0,
          conVida: 0,
          desaparecida: 0,
          sinVida: 0
        };
      }
      stats.porMeses[grupoMeses].total++;
      if (condicion === "CON VIDA") stats.porMeses[grupoMeses].conVida++;
      else if (condicion === "DESAPARECIDA") stats.porMeses[grupoMeses].desaparecida++;
      else if (condicion === "SIN VIDA") stats.porMeses[grupoMeses].sinVida++;
    });

    // Calcular probabilidades
    this.calcularProbabilidades(stats);

    // DEBUG: Mostrar estad√≠sticas
    if (this.debug) {
      console.log("=== DEBUG: Estad√≠sticas calculadas ===");
      console.log("General:", {
        total: stats.general.total,
        conVida: stats.general.conVida,
        desaparecida: stats.general.desaparecida,
        sinVida: stats.general.sinVida,
        probConVida: stats.general.probConVida,
        probDesaparecida: stats.general.probDesaparecida,
        probSinVida: stats.general.probSinVida
      });

      console.log("Municipios con datos:", Object.keys(stats.porMunicipio).length);
      console.log("Sexos con datos:", Object.keys(stats.porSexo));
      console.log("Rangos de edad con datos:", Object.keys(stats.porEdad));
      console.log("Grupos de meses con datos:", Object.keys(stats.porMeses));

      // Mostrar distribuci√≥n general
      console.log("=== DEBUG: Distribuci√≥n general ===");
      console.log(`Con vida: ${stats.general.conVida} (${(stats.general.probConVida*100).toFixed(1)}%)`);
      console.log(`Desaparecida: ${stats.general.desaparecida} (${(stats.general.probDesaparecida*100).toFixed(1)}%)`);
      console.log(`Sin vida: ${stats.general.sinVida} (${(stats.general.probSinVida*100).toFixed(1)}%)`);
    }

    this.estadisticas = stats;
    this.isTrained = true;

    return stats;
  }

  normalizarTexto(texto) {
    if (!texto) return "";
    return texto
      .normalize("NFD")
      .replace(/[ÃÄ-ÕØ]/g, "")
      .toUpperCase()
      .trim();
  }

  crearEstadisticasBasicas() {
    console.log("=== DEBUG: Creando estad√≠sticas b√°sicas ===");

    const stats = {
      porMunicipio: {},
      porSexo: {
        'MUJER': {
          total: 100,
          conVida: 35,
          desaparecida: 40,
          sinVida: 25,
          probConVida: 0.35,
          probDesaparecida: 0.4,
          probSinVida: 0.25
        },
        'HOMBRE': {
          total: 100,
          conVida: 30,
          desaparecida: 45,
          sinVida: 25,
          probConVida: 0.3,
          probDesaparecida: 0.45,
          probSinVida: 0.25
        }
      },
      porEdad: {},
      porMeses: {},
      porSexoEdad: {},
      general: {
        total: 200,
        conVida: 65,
        desaparecida: 85,
        sinVida: 50,
        probConVida: 0.325,
        probDesaparecida: 0.425,
        probSinVida: 0.25
      }
    };

    const rangosEdad = [
      '0-4', '5-9', '10-14', '15-19', '20-24', '25-29', '30-34',
      '35-39', '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74'
    ];

    rangosEdad.forEach(rango => {
      // Ajustar probabilidades seg√∫n edad (j√≥venes tienen m√°s probabilidad de ser encontrados con vida)
      let probConVida, probDesaparecida, probSinVida;
      const edadNum = parseInt(rango.split('-')[0]);

      if (edadNum < 20) {
        // J√≥venes
        probConVida = 0.35;
        probDesaparecida = 0.45;
        probSinVida = 0.20;
      } else if (edadNum > 60) {
        // Adultos mayores
        probConVida = 0.20;
        probDesaparecida = 0.35;
        probSinVida = 0.45;
      } else {
        // Adultos
        probConVida = 0.30;
        probDesaparecida = 0.40;
        probSinVida = 0.30;
      }

      stats.porEdad[rango] = {
        total: 30,
        conVida: Math.round(30 * probConVida),
        desaparecida: Math.round(30 * probDesaparecida),
        sinVida: Math.round(30 * probSinVida),
        probConVida: probConVida,
        probDesaparecida: probDesaparecida,
        probSinVida: probSinVida
      };
    });

    for (let i = 0; i <= 10; i++) {
      const factor = i / 10;
      const probConVida = Math.max(0.2, 0.4 - (factor * 0.2));
      const probDesaparecida = 0.4;
      const probSinVida = Math.min(0.4, 0.2 + (factor * 0.2));

      stats.porMeses[i] = {
        total: 25,
        conVida: Math.round(25 * probConVida),
        desaparecida: Math.round(25 * probDesaparecida),
        sinVida: Math.round(25 * probSinVida),
        probConVida: probConVida,
        probDesaparecida: probDesaparecida,
        probSinVida: probSinVida
      };
    }

    this.estadisticas = stats;
    this.isTrained = true;

    console.log("=== DEBUG: Estad√≠sticas b√°sicas creadas ===");

    return stats;
  }

  calcularProbabilidades(stats) {
    // Probabilidades generales
    const total = stats.general.total;
    if (total > 0) {
      stats.general.probConVida = stats.general.conVida / total;
      stats.general.probDesaparecida = stats.general.desaparecida / total;
      stats.general.probSinVida = stats.general.sinVida / total;
    } else {
      stats.general.probConVida = 0.33;
      stats.general.probDesaparecida = 0.34;
      stats.general.probSinVida = 0.33;
    }

    // Funci√≥n helper para calcular probabilidades con suavizado de Laplace
    const calcularProb = (obj) => {
      const laplaceAlpha = 1; // Par√°metro de suavizado
      const k = 3; // N√∫mero de categor√≠as

      if (obj.total > 0) {
        // Suavizado de Laplace para evitar probabilidades de 0
        obj.probConVida = (obj.conVida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
        obj.probDesaparecida = (obj.desaparecida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
        obj.probSinVida = (obj.sinVida + laplaceAlpha) / (obj.total + laplaceAlpha * k);
      } else {
        // Si no hay datos, usar probabilidades generales
        obj.probConVida = stats.general.probConVida;
        obj.probDesaparecida = stats.general.probDesaparecida;
        obj.probSinVida = stats.general.probSinVida;
      }
    };

    // Calcular probabilidades para todas las categor√≠as
    Object.keys(stats.porMunicipio).forEach(mun => calcularProb(stats.porMunicipio[mun]));
    Object.keys(stats.porSexo).forEach(sexo => calcularProb(stats.porSexo[sexo]));
    Object.keys(stats.porEdad).forEach(edad => calcularProb(stats.porEdad[edad]));
    Object.keys(stats.porSexoEdad).forEach(clave => calcularProb(stats.porSexoEdad[clave]));
    Object.keys(stats.porMeses).forEach(grupo => calcularProb(stats.porMeses[grupo]));
  }

  predecir(sexo, edad, meses, municipio) {
    console.log("=== DEBUG: Iniciando predicci√≥n ===");
    console.log("Input:", { sexo, edad, meses, municipio });

    if (!this.isTrained || !this.estadisticas) {
      console.warn("Modelo no entrenado, usando probabilidades base");
      return this.predecirBase(sexo, edad, meses, municipio);
    }

    sexo = this.normalizarTexto(sexo);
    municipio = this.normalizarTexto(municipio);

    const rangoEdad = this.convertirEdadARango(edad);
    const claveSexoEdad = `${sexo}_${rangoEdad}`;
    const grupoMeses = Math.min(10, Math.floor(meses / 6));

    console.log("=== DEBUG: Par√°metros normalizados ===");
    console.log("Sexo:", sexo);
    console.log("Municipio:", municipio);
    console.log("Rango Edad:", rangoEdad);
    console.log("Clave Sexo-Edad:", claveSexoEdad);
    console.log("Grupo Meses:", grupoMeses);

    const probGeneral = this.estadisticas.general;

    const probMunicipio = this.estadisticas.porMunicipio[municipio];
    const probSexo = this.estadisticas.porSexo[sexo];
    const probEdad = this.estadisticas.porEdad[rangoEdad];
    const probSexoEdad = this.estadisticas.porSexoEdad[claveSexoEdad];
    const probMeses = this.estadisticas.porMeses[grupoMeses];

    console.log("=== DEBUG: Probabilidades encontradas ===");
    console.log("Municipio:", probMunicipio ? `S√≠ (${probMunicipio.total} datos)` : "No");
    console.log("Sexo:", probSexo ? `S√≠ (${probSexo.total} datos)` : "No");
    console.log("Edad:", probEdad ? `S√≠ (${probEdad.total} datos)` : "No");
    console.log("Sexo-Edad:", probSexoEdad ? `S√≠ (${probSexoEdad.total} datos)` : "No");
    console.log("Meses:", probMeses ? `S√≠ (${probMeses.total} datos)` : "No");

    let pConVida = 0;
    let pDesaparecida = 0;
    let pSinVida = 0;
    let totalPeso = 0;

    const agregarProbabilidad = (prob, pesoBase, nombre) => {
      if (prob && prob.total > 0) {
        const confianza = Math.min(1.0, prob.total / 100);
        const pesoAjustado = pesoBase * (0.3 + 0.7 * confianza);

        pConVida += prob.probConVida * pesoAjustado;
        pDesaparecida += prob.probDesaparecida * pesoAjustado;
        pSinVida += prob.probSinVida * pesoAjustado;
        totalPeso += pesoAjustado;

        console.log(`  ${nombre}: peso=${pesoAjustado.toFixed(3)}, datos=${prob.total}`);
      }
    };

    console.log("=== DEBUG: Acumulando probabilidades ===");

    agregarProbabilidad(probMunicipio, 0.30, "Municipio");
    agregarProbabilidad(probSexoEdad, 0.25, "Sexo-Edad");
    agregarProbabilidad(probMeses, 0.20, "Meses");
    agregarProbabilidad(probEdad, 0.15, "Edad");
    agregarProbabilidad(probSexo, 0.10, "Sexo");

    if (totalPeso === 0) {
      console.log("  Usando solo probabilidades generales");
      pConVida = probGeneral.probConVida;
      pDesaparecida = probGeneral.probDesaparecida;
      pSinVida = probGeneral.probSinVida;
      totalPeso = 1.0;
    } else {

      pConVida /= totalPeso;
      pDesaparecida /= totalPeso;
      pSinVida /= totalPeso;
    }


    const factorMeses = Math.min(1.0, meses / 60);
    pConVida *= (1 - factorMeses * 0.5);
    pSinVida *= (1 + factorMeses * 0.3);
    pDesaparecida = 1 - pConVida - pSinVida;

    pConVida = Math.max(0.05, pConVida);
    pDesaparecida = Math.max(0.05, pDesaparecida);
    pSinVida = Math.max(0.05, pSinVida);

    const totalProb = pConVida + pDesaparecida + pSinVida;
    pConVida /= totalProb;
    pDesaparecida /= totalProb;
    pSinVida /= totalProb;

    // Convertir a porcentajes
    let conVida = Math.round(pConVida * 100);
    let desaparecida = Math.round(pDesaparecida * 100);
    let sinVida = Math.round(pSinVida * 100);

    const ajustado = this.ajustarSuma100(conVida, desaparecida, sinVida);

    // Determinar clase m√°s probable
    let clase = "DESAPARECIDA";
    if (ajustado.conVida > ajustado.desaparecida && ajustado.conVida > ajustado.sinVida) {
      clase = "CON VIDA";
    } else if (ajustado.sinVida > ajustado.desaparecida && ajustado.sinVida > ajustado.conVida) {
      clase = "SIN VIDA";
    }

    // Calcular confianza basada en los datos disponibles
    const confianza = this.calcularConfianza(probMunicipio, probSexoEdad, probMeses);

    console.log("=== DEBUG: Resultado final ===");
    console.log("Con vida:", ajustado.conVida, "%");
    console.log("Desaparecida:", ajustado.desaparecida, "%");
    console.log("Sin vida:", ajustado.sinVida, "%");
    console.log("Clase:", clase);
    console.log("Confianza:", confianza, "%");

    return {
      conVida: ajustado.conVida,
      desaparecida: ajustado.desaparecida,
      sinVida: ajustado.sinVida,
      clase: clase,
      confianza: confianza
    };
  }

  predecirBase(sexo, edad, meses, municipio) {
    console.log("=== DEBUG: Usando predicci√≥n base ===");

    // Predicci√≥n base con variabilidad realista
    const rangoEdad = this.convertirEdadARango(edad);

    let baseConVida = 25;
    let baseDesaparecida = 50;
    let baseSinVida = 25;

    if (sexo === "MUJER") {
      baseConVida += 5;
      baseDesaparecida -= 3;
    } else {
      baseConVida -= 3;
      baseSinVida += 3;
    }

    if (edad < 18) {
      baseConVida += 15;
      baseSinVida -= 10;
    } else if (edad > 60) {
      baseConVida -= 8;
      baseSinVida += 8;
    }

    if (meses < 3) {
      baseConVida += 10;
      baseDesaparecida += 5;
      baseSinVida -= 15;
    } else if (meses > 24) {
      baseConVida -= 15;
      baseDesaparecida -= 10;
      baseSinVida += 25;
    }

    // Asegurar valores m√≠nimos
    baseConVida = Math.max(5, baseConVida);
    baseDesaparecida = Math.max(10, baseDesaparecida);
    baseSinVida = Math.max(5, baseSinVida);

    // Normalizar
    const total = baseConVida + baseDesaparecida + baseSinVida;

    let conVida = Math.round((baseConVida / total) * 100);
    let desaparecida = Math.round((baseDesaparecida / total) * 100);
    let sinVida = 100 - conVida - desaparecida;

    const ajustado = this.ajustarSuma100(conVida, desaparecida, sinVida);

    let clase = "DESAPARECIDA";
    if (ajustado.conVida > ajustado.desaparecida && ajustado.conVida > ajustado.sinVida) {
      clase = "CON VIDA";
    } else if (ajustado.sinVida > ajustado.desaparecida && ajustado.sinVida > ajustado.conVida) {
      clase = "SIN VIDA";
    }

    console.log("=== DEBUG: Predicci√≥n base resultado ===");
    console.log(ajustado, "Clase:", clase);

    return {
      conVida: ajustado.conVida,
      desaparecida: ajustado.desaparecida,
      sinVida: ajustado.sinVida,
      clase: clase,
      confianza: 60
    };
  }

  convertirEdadARango(edad) {
    if (edad <= 4) return "0-4";
    if (edad <= 9) return "5-9";
    if (edad <= 14) return "10-14";
    if (edad <= 19) return "15-19";
    if (edad <= 24) return "20-24";
    if (edad <= 29) return "25-29";
    if (edad <= 34) return "30-34";
    if (edad <= 39) return "35-39";
    if (edad <= 44) return "40-44";
    if (edad <= 49) return "45-49";
    if (edad <= 54) return "50-54";
    if (edad <= 59) return "55-59";
    if (edad <= 64) return "60-64";
    if (edad <= 69) return "65-69";
    return "70-74";
  }

  ajustarSuma100(a, b, c) {
    const total = a + b + c;
    if (total === 100) return { conVida: a, desaparecida: b, sinVida: c };

    const diff = 100 - total;
    const ajuste = Math.abs(diff);

    if (a >= b && a >= c) return { conVida: a + diff, desaparecida: b, sinVida: c };
    if (b >= a && b >= c) return { conVida: a, desaparecida: b + diff, sinVida: c };
    return { conVida: a, desaparecida: b, sinVida: c + diff };
  }

  calcularConfianza(probMunicipio, probSexoEdad, probMeses) {
    let confianza = 50;

    if (probMunicipio && probMunicipio.total > 0) {
      confianza += Math.min(25, Math.log10(probMunicipio.total + 1) * 10);
    }

    if (probSexoEdad && probSexoEdad.total > 0) {
      confianza += Math.min(15, Math.log10(probSexoEdad.total + 1) * 5);
    }

    if (probMeses && probMeses.total > 0) {
      confianza += Math.min(10, Math.log10(probMeses.total + 1) * 3);
    }

    return Math.min(95, Math.max(40, confianza));
  }
}


const predictor = new SimplePredictor();


function abrirNota() {
  document.getElementById('modalNota').style.display = 'block';
}

function cerrarNota() {
  document.getElementById('modalNota').style.display = 'none';
}

function abrirPrediccion() {
  document.getElementById("modalPrediccion").style.display = "block";
}

function cerrarPrediccion() {
  document.getElementById("modalPrediccion").style.display = "none";
}

function toggleSection(sec) {
  const content = document.getElementById(`section-${sec}`);
  const button = document.querySelector(
    `.section-toggle[onclick="toggleSection('${sec}')"]`
  );

  const isCollapsed = content.classList.contains('collapsed');

  // Abrir / cerrar SOLO la secci√≥n tocada
  content.classList.toggle('collapsed');

  // Activar / desactivar SOLO su bot√≥n
  if (isCollapsed) {
    button.classList.add('active');
  } else {
    button.classList.remove('active');
  }
}


function obtenerMunicipiosOrdenadosPorCasos(datos) {
  const totales = {};

  datos.forEach(d => {
    if (!totales[d.municipio]) {
      totales[d.municipio] = 0;
    }
    totales[d.municipio] += Number(d.total) || 0;
  });

  const municipiosArray = Object.entries(totales);
  municipiosArray.sort((a, b) => b[1] - a[1]);

  const top10 = municipiosArray.slice(0, 10);
  const restantes = municipiosArray.slice(10);

  restantes.sort((a, b) =>
    a[0].localeCompare(b[0], 'es', { sensitivity: 'base' })
  );

  return [...top10, ...restantes].map(([municipio]) => municipio);
}

function llenarSelectoresMultiples(municipios) {
  // Llenar selector m√∫ltiple de gr√°ficas
  llenarMultiple("municipiosComparacion", municipios);
  // Llenar selector de predicci√≥n
  llenar("predMunicipio", municipios, false);
}

// Nueva funci√≥n para llenar selects m√∫ltiples
function llenarMultiple(id, valores) {
  const s = document.getElementById(id);
  if (!s) return;

  s.innerHTML = '';
  
  // Agregar opci√≥n "TODOS" primero
  s.innerHTML += '<option value="TODOS">TODOS LOS MUNICIPIOS</option>';
  
  valores.forEach(v => {
    s.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function llenar(id, valores, usarTotal = true) {
  const s = document.getElementById(id);
  if (!s) return;

  s.innerHTML = "";
  if (usarTotal) s.innerHTML += `<option value="TOTAL">TODOS</option>`;
  valores.forEach(v => {
    s.innerHTML += `<option value="${v}">${v}</option>`;
  });
}

function poblarSelectoresGraficas() {
  if (!datos || datos.length === 0) return;

  try {
    const municipios = obtenerMunicipiosOrdenadosPorCasos(datos);
    llenarSelectoresMultiples(municipios);

    const anios = [...new Set(datos.map(d => Number(d.a√±o)))]
      .sort((a, b) => b - a);
    llenar("anio", anios, false);
    llenar("aniosSeleccionados", anios, false);

    const sexos = [...new Set(datos.map(d => d.sexo))].sort();
    llenar("sexo", sexos);

        const rangosEdad = [
      "0-14",
      "15-24",
      "25-39",
      "40-59",
      "60+"
    ];

    llenar("edad", rangosEdad, true); // true = a√±ade opci√≥n "TOTAL"
    
// Agregar evento para el bot√≥n "Seleccionar Todos" - VERSI√ìN MEJORADA
document.getElementById('seleccionarTodos').addEventListener('click', function() {
  const select = document.getElementById('municipiosComparacion');
  if (!select) return;
  
  const todasOpciones = Array.from(select.options);
  
  // Verificar si TODOS est√° seleccionado
  const todosOption = select.querySelector('option[value="TODOS"]');
  const tieneTodos = todosOption && todosOption.selected;
  
  if (tieneTodos || this.dataset.state === 'todos-seleccionados') {
    // DESELECCIONAR todo
    todasOpciones.forEach(opt => opt.selected = false);
    this.textContent = 'Seleccionar Todos';
    this.dataset.state = '';
    this.style.backgroundColor = '#6c757d'; // Color normal
  } else {
    // SELECCIONAR todo (pero NO la opci√≥n "TODOS")
    todasOpciones.forEach(opt => {
      if (opt.value !== "TODOS") {
        opt.selected = true;
      }
    });
    this.textContent = 'Deseleccionar Todos';
    this.dataset.state = 'todos-seleccionados';
    this.style.backgroundColor = '#dc3545'; // Color rojo para indicar "deseleccionar"
  }
  
  // Disparar evento change manualmente para actualizar contador
  select.dispatchEvent(new Event('change'));
});

    // Actualizar contador cuando cambia la selecci√≥n
    document.getElementById('municipiosComparacion').addEventListener('change', actualizarContadorMunicipios);
    
    // Inicializar contador
    actualizarContadorMunicipios();
    
  } catch (error) {
    console.error("Error poblando selectores:", error);
  }
}

// Funci√≥n para actualizar contador de municipios seleccionados
function actualizarContadorMunicipios() {
  const select = document.getElementById('municipiosComparacion');
  const seleccionados = Array.from(select.selectedOptions);
  const contador = document.getElementById('contadorMunicipios');
  
  if (!contador) return;
  
  const totalOpciones = select.options.length - 1; // Restar la opci√≥n "TODOS"
  
  if (seleccionados.some(opt => opt.value === "TODOS")) {
    contador.textContent = `Seleccionados: TODOS LOS MUNICIPIOS (${totalOpciones})`;
  } else {
    contador.textContent = `Seleccionados: ${seleccionados.length} de ${totalOpciones} municipios`;
  }
}

function generarGrafica() {
  try {
    // Obtener municipios seleccionados del select m√∫ltiple
    const selectMunicipios = document.getElementById('municipiosComparacion');
    const opcionesSeleccionadas = Array.from(selectMunicipios.selectedOptions);
    
    if (opcionesSeleccionadas.length === 0) {
      alert("Por favor selecciona al menos un municipio.");
      return;
    }

    // Verificar si se seleccion√≥ "TODOS"
    const tieneTodos = opcionesSeleccionadas.some(opt => opt.value === "TODOS");
    
    let municipiosUsar = [];
    
    if (tieneTodos) {
      // Obtener todos los municipios (excluyendo la opci√≥n "TODOS")
      municipiosUsar = Array.from(selectMunicipios.options)
        .filter(opt => opt.value !== "TODOS")
        .map(opt => opt.value);
    } else {
      // Usar solo los municipios seleccionados
      municipiosUsar = opcionesSeleccionadas.map(opt => opt.value);
    }

    // Validar cantidad de municipios (opcional)
    if (municipiosUsar.length > 15 && !confirm(`Est√°s seleccionando ${municipiosUsar.length} municipios. La gr√°fica puede ser dif√≠cil de leer. ¬øDeseas continuar?`)) {
      return;
    }

    const sexoSel = document.getElementById('sexo').value;
    const edadSel = document.getElementById('edad').value;
    const anioSel = Number(document.getElementById('anio').value);
    const metricaSel = document.getElementById('metrica').value;
    const modoSel = document.getElementById('modo').value;
    const filtrarAnios = document.getElementById('filtrarAnios').checked;

    let filtrado = datos.filter(d =>
      municipiosUsar.includes(d.municipio) &&
      (sexoSel === "TOTAL" || d.sexo === sexoSel) &&
      (edadSel === "TOTAL" || d.rango_edad === edadSel)
    );

    if (filtrado.length === 0) {
      alert("No hay datos disponibles para los filtros seleccionados.");
      return;
    }

    if (modoSel === "temporal" && filtrarAnios) {
      const selectedOptions = Array.from(document.getElementById('aniosSeleccionados').selectedOptions);
      if (selectedOptions.length > 0) {
        const aniosSeleccionados = selectedOptions.map(option => Number(option.value));
        filtrado = filtrado.filter(d => aniosSeleccionados.includes(d.a√±o));
      }
    }

    if (chartAnalisis) {
      chartAnalisis.destroy();
    }

    const titulo = `Municipios: ${municipiosUsar.length > 3 ? 
      `${municipiosUsar.slice(0, 3).join(", ")}... (${municipiosUsar.length} total)` : 
      municipiosUsar.join(", ")}`;
    
    let subtitulo = "";

    if (modoSel === "simple") {
      subtitulo = `A√±o: ${anioSel}`;
    } else {
      subtitulo = "Evoluci√≥n temporal por a√±o";
      if (filtrarAnios) {
        const selectedYears = Array.from(document.getElementById('aniosSeleccionados').selectedOptions)
          .map(o => o.value)
          .sort((a, b) => a - b);
        if (selectedYears.length > 0) {
          subtitulo += ` (A√±os seleccionados: ${selectedYears.join(", ")})`;
        }
      }
    }

    let labels = [];
    let datasets = [];

    if (modoSel === "simple") {
      filtrado = filtrado.filter(d => d.a√±o === anioSel);

      if (filtrado.length === 0) {
        alert(`No hay datos disponibles para el a√±o ${anioSel} con los filtros seleccionados.`);
        return;
      }

      labels = municipiosUsar;
      const categorias = [...new Set(filtrado.map(d => d[metricaSel]))].sort();

      datasets = categorias.map(cat => ({
        label: cat,
        data: municipiosUsar.map(mun => {
          const items = filtrado.filter(d =>
            d.municipio === mun &&
            d[metricaSel] === cat
          );
          return items.reduce((sum, d) => sum + d.total, 0);
        })
      }));

    } else {
      labels = [...new Set(filtrado.map(d => d.a√±o))].sort((a, b) => a - b);
      
      // Para muchos municipios, agrupar por municipio en lugar de por categor√≠a
      if (municipiosUsar.length > 8) {
        datasets = municipiosUsar.map(mun => {
          const data = labels.map(anio => {
            const items = filtrado.filter(d =>
              d.municipio === mun &&
              d.a√±o === anio
            );
            return items.reduce((sum, d) => sum + d.total, 0);
          });

          return {
            label: mun,
            data: data,
            tension: 0.25,
            borderWidth: 2,
            fill: false
          };
        });
      } else {
        // M√©todo original para pocos municipios
        const categorias = [...new Set(filtrado.map(d => d[metricaSel]))].sort();
        datasets = [];
        
        municipiosUsar.forEach(mun => {
          categorias.forEach(cat => {
            const data = labels.map(anio => {
              const items = filtrado.filter(d =>
                d.municipio === mun &&
                d[metricaSel] === cat &&
                d.a√±o === anio
              );
              return items.reduce((sum, d) => sum + d.total, 0);
            });

            if (data.some(val => val > 0)) {
              datasets.push({
                label: `${mun} ‚Äì ${cat}`,
                data: data,
                tension: 0.25,
                borderWidth: 2
              });
            }
          });
        });
      }

      if (datasets.length === 0) {
        alert("No hay datos para mostrar con los filtros seleccionados.");
        return;
      }
    }

    renderChart(labels, datasets, modoSel === "temporal", titulo, subtitulo);
    document.getElementById('resumen').innerText = subtitulo;

  } catch (error) {
    console.error("Error generando gr√°fica:", error);
    alert(`Error al generar la gr√°fica: ${error.message}`);
  }
}

function renderChart(labels, datasets, temporal, titulo, subtitulo) {
// Obtener el rango de edad seleccionado del selector
const selectorEdad = document.getElementById('edad');
const rangoEdadSeleccionado = selectorEdad ? selectorEdad.value : 'TODOS';

// Obtener el sexo seleccionado del selector
const selectorSexo = document.getElementById('sexo');
const sexoSeleccionado = selectorSexo ? selectorSexo.value : 'TODOS';

// Modificar el subt√≠tulo para incluir el rango de edad Y el sexo
let subtituloCompleto = subtitulo;

// Agregar informaci√≥n de edad
if (rangoEdadSeleccionado && rangoEdadSeleccionado !== 'TOTAL') {
  subtituloCompleto += ` | Rango de edad: ${rangoEdadSeleccionado}`;
} else if (rangoEdadSeleccionado === 'TOTAL') {
  subtituloCompleto += ` | Rango de edad: TODOS`;
}

// Agregar informaci√≥n de sexo
if (sexoSeleccionado && sexoSeleccionado !== 'TOTAL') {
  subtituloCompleto += ` | Sexo: ${sexoSeleccionado}`;
} else if (sexoSeleccionado === 'TOTAL') {
  subtituloCompleto += ` | Sexo: TODOS`;
}

  let type = chartType;
  let stacked = false;
  let fillArea = false;

  if (chartType === "area") { type = "line"; fillArea = true; }
  if (chartType === "stackedArea") { type = "line"; fillArea = true; stacked = true; }
  if (chartType === "stackedBar") { type = "bar"; stacked = true; }

  const enhancedDatasets = apply3DEffects(datasets, type, fillArea);

  let finalLabels = labels;
  let finalDatasets = enhancedDatasets;

  if (type === 'pie') {
    finalLabels = enhancedDatasets.map(d => d.label);

    const values = enhancedDatasets.map(d =>
      d.data.reduce((a, b) => a + b, 0)
    );

    finalDatasets = [{
      label: 'Distribuci√≥n',
      data: values,
      backgroundColor: enhancedDatasets.map(
        d => Array.isArray(d.backgroundColor)
          ? d.backgroundColor[0]
          : d.backgroundColor || d.borderColor
      ),
      borderColor: '#ffffff',
      borderWidth: 2
    }];
  }

  const options = {
    responsive: true,
    maintainAspectRatio: false,
    indexAxis: 'x',
    radius: (type === 'pie' || type === 'doughnut') ? '90%' : '100%',

    animation: {
      duration: 800,
      easing: 'easeOutQuart'
    },

    scales: type === 'pie' ? {} : {
      x: {
        stacked: stacked,
        ticks: { font: { size: 10 } },
        grid: { color: 'rgba(0,0,0,0.1)' }
      },
      y: {
        stacked: stacked,
        beginAtZero: true,
        grace: '10%',

        ticks: {
          font: { size: 10 },
          callback: v => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v
        },
        grid: { color: 'rgba(0,0,0,0.1)' }
      }
    },

    plugins: {
      legend: {
        display: true,
        position: 'top',
        labels: {
          font: { size: 8 },
          usePointStyle: true,
          pointStyle: 'rect'
        }
      },

      title: {
        display: true,
        text: titulo,
        font: { size: 8, weight: 'bold' },
        padding: { top: 8, bottom: 8 }
      },

      subtitle: {
        display: true,
        text: subtituloCompleto,
        font: { size: 8 },
        padding: { bottom: 5 }
      },

      tooltip: {
        display: true,
        backgroundColor: 'rgba(0,0,0,0.75)',
        titleColor: '#fff',
        bodyColor: '#fff',
        displayColors: true
      },

      watermark: {
        text: 'rys2000dev',
        fontSize: 26,
        opacity: 0.07,
        angle: 0
      },

      datalabels: {
        display: ctx => {
          const v = ctx.dataset.data[ctx.dataIndex];
          return typeof v === 'number' && v > 0;
        },

        formatter: v => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v,

        color: ctx => {
          const t = ctx.chart.config.type;
          const stacked =
            ctx.chart.options.scales?.x?.stacked ||
            ctx.chart.options.scales?.y?.stacked;

          if (t === 'line') return '#ffffff';
          if (stacked) return '#000000';
          return '#000000';
        },

        font: ctx =>
          ctx.chart.config.type === 'line'
            ? { weight: 'bold', size: 10 }
            : { weight: 'bold', size: 11 },

        anchor: ctx =>
          ctx.chart.config.type === 'line'
            ? 'center'
            : (ctx.chart.options.scales?.x?.stacked ? 'center' : 'end'),

        align: ctx =>
          ctx.chart.config.type === 'line'
            ? 'center'
            : (ctx.chart.options.scales?.x?.stacked ? 'center' : 'top'),

        offset: ctx => ctx.chart.config.type === 'line' ? 0 : 4,
        clamp: true
      }
    }
  };

  const ctx = document.getElementById('grafica');
  try {
    if (chartAnalisis) {
      chartAnalisis.destroy();
    }

    chartAnalisis = new Chart(ctx, {
      type: type,
      data: {
        labels: finalLabels,
        datasets: finalDatasets
      },
      options: options,
      plugins: [ChartDataLabels]
    });
  } catch (error) {
    console.error("Error creando gr√°fica de Chart.js:", error);
    alert(`Error al crear la gr√°fica: ${error.message}`);
  }
}

function descargarGrafica() {
  if (!chartAnalisis) return;
  try {
    const a = document.createElement("a");
    a.href = chartAnalisis.toBase64Image();
    a.download = "grafica_desapariciones.png";
    a.click();
  } catch (error) {
    console.error("Error descargando gr√°fica:", error);
    alert("Error al descargar la gr√°fica.");
  }
}

function descargarGrafica() {
  if (!chartAnalisis) return;
  try {
    const a = document.createElement("a");
    a.href = chartAnalisis.toBase64Image();
    a.download = "grafica_desapariciones.png";
    a.click();
  } catch (error) {
    console.error("Error descargando gr√°fica:", error);
    alert("Error al descargar la gr√°fica.");
  }
}

function mostrarResultadosPrediccion(prediccion) {
  // Actualizar porcentajes
  document.getElementById('probConVida').textContent = `${prediccion.conVida}%`;
  document.getElementById('probDesaparecida').textContent = `${prediccion.desaparecida}%`;
  document.getElementById('probSinVida').textContent = `${prediccion.sinVida}%`;

  // Animar barras
  setTimeout(() => {
    document.getElementById('barConVida').style.width = `${prediccion.conVida}%`;
    document.getElementById('barDesaparecida').style.width = `${prediccion.desaparecida}%`;
    document.getElementById('barSinVida').style.width = `${prediccion.sinVida}%`;
  }, 100);

  // Mostrar secci√≥n de resultados
  const resultsDiv = document.getElementById('predictionResults');
  resultsDiv.style.display = 'block';

  // Actualizar informaci√≥n
  document.getElementById('modelInfo').innerHTML = `
    Resultado m√°s probable: <strong>${prediccion.clase}</strong><br>
    <em>Confianza estimada: ${prediccion.confianza}%</em>
  `;
}

// =========================
// CARGA DE DATOS
// =========================
window.addEventListener('DOMContentLoaded', () => {
  // 1. Cargar datos para gr√°ficas
  fetch("stats_municipios_simple.json")
    .then(r => r.json())
    .then(json => {
      datos = json;
      poblarSelectoresGraficas();
      console.log("=== DEBUG: Datos para gr√°ficas cargados:", datos.length);
    })
    .catch(error => {
      console.error("Error cargando datos para gr√°ficas:", error);
      alert("Error al cargar los datos para gr√°ficas. Verifica que el archivo stats_municipios_simple.json exista.");
    });

  // 2. Cargar datos para entrenamiento del modelo
  fetch("stats_ml_training.json")
    .then(r => r.json())
    .then(json => {
      datosEntrenamiento = json;
      console.log("=== DEBUG: Datos de entrenamiento crudos:", datosEntrenamiento.length);

      const statusEl = document.getElementById('modelStatus');
      statusEl.textContent = "‚è≥ Analizando datos de entrenamiento...";
      statusEl.className = "model-status training";

      try {
        const stats = predictor.prepararEstadisticas(datosEntrenamiento);

        statusEl.textContent = `‚úÖ Modelo listo! (${stats.general.total} casos analizados)`;
        statusEl.className = "model-status ready";

        // Actualizar informaci√≥n del modelo
        const modelInfo = document.getElementById('modelInfo');
        if (modelInfo) {
          modelInfo.innerHTML = `
            Modelo basado en ${stats.general.total.toLocaleString()} casos hist√≥ricos<br>
            ${Object.keys(stats.porMunicipio).length} municipios analizados
          `;
        }

        console.log("=== DEBUG: Modelo entrenado exitosamente");

        // Habilitar bot√≥n de predicci√≥n
        document.getElementById('btnPrediccion').disabled = false;
        document.getElementById('btnPrediccion').textContent = "Calcular Probabilidad";

      } catch (error) {
        console.error("Error entrenando modelo:", error);
        statusEl.textContent = "‚ö†Ô∏è Modelo usando datos b√°sicos";
        statusEl.className = "model-status error";
        document.getElementById('btnPrediccion').disabled = false;
        document.getElementById('btnPrediccion').textContent = "Calcular (datos b√°sicos)";
      }
    })
    .catch(error => {
      console.error("Error cargando datos de entrenamiento:", error);
      const statusEl = document.getElementById('modelStatus');
      statusEl.textContent = "‚ö†Ô∏è No se pudieron cargar datos de entrenamiento";
      statusEl.className = "model-status error";
      document.getElementById('btnPrediccion').disabled = false;
      document.getElementById('btnPrediccion').textContent = "‚ö†Ô∏è Calcular (datos b√°sicos)";
    });



  document.getElementById("filtrarAnios").addEventListener("change", function() {
    document.getElementById("aniosSeleccionados").style.display = this.checked ? "block" : "none";
  });

  document.getElementById('predMeses').addEventListener('input', function() {
    document.getElementById('mesesValue').textContent = `${this.value} meses`;
  });

  // Tipo de gr√°fica
  document.querySelectorAll("#chartTypes button").forEach(btn => {
    btn.addEventListener('click', () => {
      chartType = btn.dataset.type;
      document.querySelectorAll("#chartTypes button")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  // Inicializar primer bot√≥n de gr√°fica como activo
  const firstBtn = document.querySelector('#chartTypes button');
  if (firstBtn) {
    firstBtn.classList.add('active');
    chartType = firstBtn.dataset.type;
  }

  // Generar gr√°fica
  document.getElementById('btnGenerar').addEventListener('click', generarGrafica);

  // Predicci√≥n
  document.getElementById('btnPrediccion').addEventListener('click', function() {
    if (this.disabled) {
      alert("El modelo a√∫n no est√° listo. Por favor espera.");
      return;
    }

    const sexo = document.querySelector('input[name="predSexo"]:checked').value;
    const edad = parseInt(document.getElementById('predEdad').value);
    const meses = parseInt(document.getElementById('predMeses').value);
    const municipio = document.getElementById('predMunicipio').value;

    if (!municipio) {
      alert("Por favor selecciona un municipio.");
      return;
    }

    // Mostrar loading
    const btn = this;
    const originalText = btn.textContent;
    btn.textContent = "Calculando...";
    btn.disabled = true;

    // Hacer predicci√≥n
    setTimeout(() => {
      try {
        const prediccion = predictor.predecir(sexo, edad, meses, municipio);
        mostrarResultadosPrediccion(prediccion);
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (error) {
        console.error("Error en predicci√≥n:", error);
        alert("Error al calcular la predicci√≥n: " + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }, 300);
  });
});

// Cerrar modales al hacer click fuera del contenido
window.addEventListener('click', function (e) {
  const modalNota = document.getElementById('modalNota');
  const modalPred = document.getElementById('modalPrediccion');

  if (e.target === modalNota) {
    cerrarNota();
  }

  if (e.target === modalPred) {
    cerrarPrediccion();
  }
});


</script>

</body>
</html>



